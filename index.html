<!DOCTYPE html>
<html lang="th" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>C-POS System</title>
  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { font-family: 'Sarabun', sans-serif; }
    .slide-in { animation: slideIn 0.3s ease-out; }
    .slide-out { animation: slideOut 0.3s ease-out; }
    @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
    @keyframes slideOut { from { transform: translateX(0); } to { transform: translateX(100%); } }
    .fade-in { animation: fadeIn 0.2s ease-out; }
    @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    .cart-badge { animation: pulse 0.3s ease-out; }
    @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } }
    @media print {
      body * { visibility: hidden; }
      #receipt-print, #receipt-print * { visibility: visible; }
      #receipt-print { position: absolute; left: 0; top: 0; width: 80mm; }
    }
   /* ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ó‡∏ô‡πÄ‡∏ô‡∏≠‡∏£‡πå‡∏£‡∏π‡∏õ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏µ‡πà‡∏¢‡∏°‡∏à‡∏±‡∏ï‡∏∏‡∏£‡∏±‡∏™ */
.aspect-square {
  aspect-ratio: 1 / 1;
  width: 100%;
  position: relative;
  overflow: hidden;
}

/* ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÉ‡∏´‡πâ‡∏î‡∏π‡∏Ñ‡∏•‡∏µ‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô */
.product-card {
  display: flex;
  flex-direction: column;
  height: 150px; /* ‡πÉ‡∏´‡πâ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ó‡∏∏‡∏Å‡πÉ‡∏ö‡∏™‡∏π‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ô‡πÉ‡∏ô‡πÅ‡∏ñ‡∏ß‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô */
  object-fit: cover; /* ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡∏ö‡∏¥‡∏î‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏ß‡πÅ‡∏•‡∏∞‡πÄ‡∏ï‡πá‡∏°‡∏Å‡∏£‡∏≠‡∏ö */
}

.product-card img {
  width: 100%;
  height: 100px; /* ‡∏õ‡∏£‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏Ç‡∏≠‡∏á‡∏£‡∏π‡∏õ‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡πá‡∏°‡∏Å‡∏≤‡∏£‡πå‡∏î */
  object-fit: cover; /* ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡∏ö‡∏¥‡∏î‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏ß‡πÅ‡∏•‡∏∞‡πÄ‡∏ï‡πá‡∏°‡∏Å‡∏£‡∏≠‡∏ö */
}
  </style>
</head>
<body class="h-full bg-gradient-to-br from-slate-100 via-blue-50 to-indigo-100">
  <div id="app" class="h-full flex flex-col overflow-hidden">
    
    <!-- Header -->
    <header class="glass-effect shadow-lg px-4 py-3 flex items-center justify-between z-30 border-b border-white/50">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-xl btn-primary flex items-center justify-center shadow-lg">
          <span class="text-white text-xl">üè™</span>
        </div>
        <div>
          <h1 id="header-store-name" class="text-xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">‡∏ä‡∏¥‡∏Å‡∏ä‡∏¥‡∏Å‡πÄ‡∏Å‡πâ‡∏ô‡∏â‡∏µ‡∏Å</h1>
          <p class="text-xs text-gray-500">C-POS ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏≤‡∏¢‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô</p>
        </div>
      </div>
      
      <!-- Navigation -->
      <nav class="flex gap-1 bg-gray-100 p-1 rounded-xl">
        <button onclick="switchTab('sell')" id="tab-sell" class="tab-btn px-4 py-2 rounded-lg text-sm font-medium transition-all bg-white shadow text-indigo-600">
          üõí ‡∏Ç‡∏≤‡∏¢
        </button>
        <button onclick="switchTab('products')" id="tab-products" class="tab-btn px-4 py-2 rounded-lg text-sm font-medium transition-all text-gray-600 hover:bg-white/50">
          üì¶ ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
        </button>
        <button onclick="switchTab('history')" id="tab-history" class="tab-btn px-4 py-2 rounded-lg text-sm font-medium transition-all text-gray-600 hover:bg-white/50">
          üìä ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
        </button>
      </nav>
      
      <!-- Cart Button -->
      <button onclick="toggleCart()" class="relative p-3 bg-white rounded-xl shadow-md hover:shadow-lg transition-all border border-gray-100">
        <span class="text-2xl">üõí</span>
        <span id="cart-count" class="absolute -top-1 -right-1 w-6 h-6 bg-red-500 text-white text-xs font-bold rounded-full flex items-center justify-center cart-badge hidden">0</span>
      </button>
    </header>
    
    <!-- Main Content -->
    <main class="flex-1 overflow-hidden relative">
      
      <!-- Sell Tab -->
      <div id="page-sell" class="page h-full flex flex-col p-4 overflow-hidden">
        <!-- Search & Filter -->
        <div class="flex gap-3 mb-4">
          <div class="flex-1 relative">
            <input type="text" id="search-product" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡πÅ‡∏Å‡∏ô‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î..." 
              class="w-full px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-indigo-400 focus:ring-4 focus:ring-indigo-100 transition-all text-lg"
              oninput="filterProducts(this.value)">
          </div>
          <select id="category-filter" onchange="filterByCategory(this.value)" 
            class="px-4 py-3 rounded-xl border-2 border-gray-200 focus:border-indigo-400 bg-white font-medium">
            <option value="">üìÅ ‡∏ó‡∏∏‡∏Å‡∏´‡∏°‡∏ß‡∏î</option>
          </select>
        </div>
        
        <!-- Products Grid -->
        <div id="products-grid" class="flex-1 overflow-y-auto grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-3 pb-4">
          <!-- Products loaded dynamically -->
        </div>
      </div>
      
      <!-- Products Management Tab -->
      <div id="page-products" class="page h-full flex flex-col p-4 overflow-hidden hidden">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-bold text-gray-800">üì¶ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
          <button onclick="showAddProductModal()" class="btn-primary text-white px-5 py-2.5 rounded-xl font-medium shadow-lg hover:shadow-xl transition-all flex items-center gap-2">
            <span>‚ûï</span> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
          </button>
        </div>
        
        <!-- Stock Table -->
        <div class="flex-1 overflow-auto bg-white rounded-2xl shadow-lg border border-gray-100">
          <table class="w-full">
            <thead class="bg-gradient-to-r from-gray-50 to-gray-100 sticky top-0">
              <tr>
                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">‡∏£‡∏π‡∏õ</th>
                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î</th>
                <th class="px-4 py-3 text-right text-sm font-semibold text-gray-600">‡∏£‡∏≤‡∏Ñ‡∏≤</th>
                <th class="px-4 py-3 text-right text-sm font-semibold text-gray-600">‡∏™‡∏ï‡πá‡∏≠‡∏Å</th>
                <th class="px-4 py-3 text-center text-sm font-semibold text-gray-600">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
              </tr>
            </thead>
            <tbody id="stock-table" class="divide-y divide-gray-100">
              <!-- Stock loaded dynamically -->
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- History Tab -->
      <div id="page-history" class="page h-full flex flex-col p-4 overflow-hidden hidden">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-bold text-gray-800">üìä ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</h2>
          <div class="flex gap-2">
            <input type="date" id="history-date" onchange="loadSalesHistory()" 
              class="px-4 py-2 rounded-xl border-2 border-gray-200 focus:border-indigo-400">
          </div>
        </div>
        
        <!-- Today Summary -->
        <div class="grid grid-cols-3 gap-4 mb-4">
          <div class="bg-gradient-to-br from-green-400 to-emerald-500 rounded-2xl p-4 text-white shadow-lg">
            <p class="text-sm opacity-90">üí∞ ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p>
            <p id="today-sales" class="text-2xl font-bold">‡∏ø0</p>
          </div>
          <div class="bg-gradient-to-br from-blue-400 to-indigo-500 rounded-2xl p-4 text-white shadow-lg">
            <p class="text-sm opacity-90">üßæ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ö‡∏¥‡∏•</p>
            <p id="today-bills" class="text-2xl font-bold">0</p>
          </div>
          <div class="bg-gradient-to-br from-purple-400 to-pink-500 rounded-2xl p-4 text-white shadow-lg">
            <p class="text-sm opacity-90">üì¶ ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢‡πÑ‡∏î‡πâ</p>
            <p id="today-items" class="text-2xl font-bold">0</p>
          </div>
        </div>
        
        <!-- Sales List -->
        <div class="flex-1 overflow-auto bg-white rounded-2xl shadow-lg border border-gray-100">
          <div id="sales-list" class="divide-y divide-gray-100">
            <!-- Sales loaded dynamically -->
          </div>
        </div>
      </div>
      
      <!-- Cart Sidebar -->
      <div id="cart-overlay" class="fixed inset-0 bg-black/50 z-40 hidden" onclick="toggleCart()"></div>
      <div id="cart-sidebar" class="fixed top-0 right-0 h-full w-96 max-w-full bg-white shadow-2xl z-50 transform translate-x-full transition-transform duration-300 flex flex-col">
        <div class="p-4 border-b bg-gradient-to-r from-indigo-500 to-purple-500 text-white">
          <div class="flex justify-between items-center">
            <h3 class="text-xl font-bold">üõí ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
            <button onclick="toggleCart()" class="p-2 hover:bg-white/20 rounded-lg transition-all">‚úï</button>
          </div>
        </div>
        
        <div id="cart-items" class="flex-1 overflow-y-auto p-4 space-y-3">
          <!-- Cart items -->
        </div>
        
        <!-- Cart Footer -->
        <div class="border-t p-4 bg-gray-50 space-y-3">
          <!-- Sale Type -->
          <div class="flex gap-2">
            <button onclick="setSaleType('store')" id="sale-type-store" class="flex-1 py-2 px-3 rounded-xl font-medium transition-all bg-indigo-100 text-indigo-700 border-2 border-indigo-400">
              üè™ ‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô
            </button>
            <button onclick="setSaleType('online')" id="sale-type-online" class="flex-1 py-2 px-3 rounded-xl font-medium transition-all bg-gray-100 text-gray-600 border-2 border-transparent">
              üåê ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå
            </button>
          </div>
          
          <div class="flex justify-between text-lg">
            <span class="text-gray-600">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
            <span id="cart-total" class="font-bold text-indigo-600">‡∏ø0</span>
          </div>
          
          <div class="grid grid-cols-2 gap-2">
            <button onclick="checkout('cash')" class="py-3 bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-xl font-bold shadow-lg hover:shadow-xl transition-all">
              üíµ ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î
            </button>
            <button onclick="checkout('promptpay')" class="py-3 bg-gradient-to-r from-blue-500 to-indigo-500 text-white rounded-xl font-bold shadow-lg hover:shadow-xl transition-all">
              üì± ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå
            </button>
          </div>
          
          <button onclick="clearCart()" class="w-full py-2 bg-red-100 text-red-600 rounded-xl font-medium hover:bg-red-200 transition-all">
            üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤
          </button>
        </div>
      </div>
    </main>
    
    <!-- Modals -->
    <!-- Add/Edit Product Modal -->
    <div id="product-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
      <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md max-h-[90%] overflow-y-auto fade-in">
        <div class="p-5 border-b bg-gradient-to-r from-indigo-500 to-purple-500 text-white rounded-t-2xl">
          <h3 id="product-modal-title" class="text-xl font-bold">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</h3>
        </div>
        <form id="product-form" class="p-5 space-y-4" onsubmit="saveProduct(event)">
          <input type="hidden" id="product-id">
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">‡∏£‡∏π‡∏õ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</label>
            <div class="flex items-center gap-3">
              <div id="product-image-preview" class="w-20 h-20 bg-gray-100 rounded-xl flex items-center justify-center text-3xl border-2 border-dashed border-gray-300">
                üì∑
              </div>
              <input type="file" id="product-image-file" accept="image/*" onchange="previewProductImage(event)" class="flex-1 text-sm">
            </div>
            <input type="hidden" id="product-image">
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ *</label>
            <input type="text" id="product-name" required class="w-full px-4 py-2.5 rounded-xl border-2 border-gray-200 focus:border-indigo-400 focus:ring-2 focus:ring-indigo-100">
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î</label>
            <input type="text" id="product-barcode" class="w-full px-4 py-2.5 rounded-xl border-2 border-gray-200 focus:border-indigo-400 focus:ring-2 focus:ring-indigo-100">
          </div>
          
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏ö‡∏≤‡∏ó) *</label>
              <input type="number" id="product-price" required min="0" step="0.01" class="w-full px-4 py-2.5 rounded-xl border-2 border-gray-200 focus:border-indigo-400 focus:ring-2 focus:ring-indigo-100">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">‡∏™‡∏ï‡πá‡∏≠‡∏Å *</label>
              <input type="number" id="product-stock" required min="0" class="w-full px-4 py-2.5 rounded-xl border-2 border-gray-200 focus:border-indigo-400 focus:ring-2 focus:ring-indigo-100">
            </div>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
            <input type="text" id="product-category" class="w-full px-4 py-2.5 rounded-xl border-2 border-gray-200 focus:border-indigo-400 focus:ring-2 focus:ring-indigo-100" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏≠‡∏≤‡∏´‡∏≤‡∏£, ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°">
          </div>
          
          <div class="flex gap-3 pt-2">
            <button type="button" onclick="closeProductModal()" class="flex-1 py-3 bg-gray-200 text-gray-700 rounded-xl font-medium hover:bg-gray-300 transition-all">
              ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
            </button>
            <button type="submit" class="flex-1 py-3 btn-primary text-white rounded-xl font-medium shadow-lg hover:shadow-xl transition-all">
              üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
            </button>
          </div>
        </form>
      </div>
    </div>
    
    <!-- Payment Modal -->
    <div id="payment-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
      <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md fade-in">
        <div id="payment-header" class="p-5 border-b bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-t-2xl">
          <h3 class="text-xl font-bold">üíµ ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</h3>
        </div>
        <div class="p-5 space-y-4">
          <div class="text-center py-4">
            <p class="text-gray-600">‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∞</p>
            <p id="payment-amount" class="text-4xl font-bold text-indigo-600">‡∏ø0</p>
          </div>
          
          <!-- Cash Payment -->
          <div id="cash-section" class="space-y-3">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)</label>
              <input type="number" id="cash-received" min="0" step="0.01" 
                class="w-full px-4 py-3 text-2xl text-center rounded-xl border-2 border-gray-200 focus:border-green-400 focus:ring-2 focus:ring-green-100"
                oninput="calculateChange()">
            </div>
            <div class="bg-yellow-50 rounded-xl p-4 text-center">
              <p class="text-sm text-gray-600">‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏≠‡∏ô</p>
              <p id="change-amount" class="text-3xl font-bold text-yellow-600">‡∏ø0</p>
            </div>
          </div>
          
          <!-- PromptPay Payment -->
          <div id="promptpay-section" class="hidden space-y-3">
            <div id="qr-container" class="text-center">
              <div id="qr-image-container" class="w-48 h-48 mx-auto bg-gray-100 rounded-xl flex items-center justify-center mb-3">
                <span class="text-6xl">üì±</span>
              </div>
              <p id="promptpay-display" class="text-lg font-medium text-gray-700">‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå: -</p>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î QR Code ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå</label>
              <input type="file" id="qr-upload" accept="image/*" onchange="uploadQRCode(event)" class="w-full text-sm">
            </div>
          </div>
          
          <div class="flex gap-3 pt-2">
            <button onclick="closePaymentModal()" class="flex-1 py-3 bg-gray-200 text-gray-700 rounded-xl font-medium hover:bg-gray-300 transition-all">
              ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
            </button>
            <button onclick="confirmPayment()" class="flex-1 py-3 btn-primary text-white rounded-xl font-bold shadow-lg hover:shadow-xl transition-all">
              ‚úÖ ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Receipt Modal -->
    <div id="receipt-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
      <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm fade-in">
        <div id="receipt-print" class="p-5">
          <div class="text-center mb-4">
            <h3 id="receipt-store-name" class="text-xl font-bold">‡∏ä‡∏¥‡∏Å‡∏ä‡∏¥‡∏Å‡πÄ‡∏Å‡πâ‡∏ô‡∏â‡∏µ‡∏Å</h3>
            <p class="text-center text-sm text-gray0">‡∏´‡∏°‡∏µ‡πà‡πÑ‡∏Å‡πà‡∏â‡∏µ‡∏Å ‡∏™‡∏≤‡∏Ç‡∏≤‡πÅ‡∏°‡πà‡πÇ‡∏à‡πâ‡∏ã‡∏≠‡∏¢ 9</p>
            <p id="receipt-store-phone" class="text-sm text-gray-600"></p>
            <div class="border-b-2 border-dashed border-gray-300 my-3"></div>
            <p class="text-sm text-gray-600" id="receipt-date"></p>
            <p class="text-2xl font-bold text-indigo-600" id="receipt-queue"></p>
            <p class="text-sm" id="receipt-sale-type"></p>
          </div>
          
          <div class="border-b-2 border-dashed border-gray-300 my-3"></div>
          
          <div id="receipt-items" class="space-y-2 text-sm">
            <!-- Receipt items -->
          </div>
          
          <div class="border-b-2 border-dashed border-gray-300 my-3"></div>
          
          <div class="space-y-1">
            <div class="flex justify-between font-bold text-lg">
              <span>‡∏£‡∏ß‡∏°</span>
              <span id="receipt-total">‡∏ø0</span>
            </div>
            <div class="flex justify-between text-sm text-gray-600">
              <span>‡∏ä‡∏≥‡∏£‡∏∞‡πÇ‡∏î‡∏¢</span>
              <span id="receipt-payment-method">-</span>
            </div>
            <div id="receipt-cash-info" class="hidden">
              <div class="flex justify-between text-sm text-gray-600">
                <span>‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</span>
                <span id="receipt-cash-received">‡∏ø0</span>
              </div>
              <div class="flex justify-between text-sm text-gray-600">
                <span>‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏≠‡∏ô</span>
                <span id="receipt-change">‡∏ø0</span>
              </div>
            </div>
          </div>
          <div>
          <hr style="border: none; border-top: 1px dashed #000; margin: 5px 0;">
            <p style="font-size: 8pt; text-align: center; margin: 0;">‡πÇ‡∏ó‡∏£: 093-145-0736</p>
            <p style="font-size: 8pt; text-align: center; margin: 0;">Facebook: ‡∏ä‡∏¥‡∏Å‡∏ä‡∏¥‡∏Å‡πÄ‡∏Å‡πâ‡∏ô‡∏â‡∏µ‡∏Å</p>
            <div style="text-align: center; font-size: 8pt; color: #555;">
                <img src="https://qr-official.line.me/gs/M_830jgqvb_BW.png?oat_content=qr" alt="QR Code" style="display: block; margin: 5px auto; width: 60px; height: 60px;">
                <p style="margin: 4px 0 0 0;">LINE:@830jgqvb</p>
            </div>
            </div>
          <div class="border-b-2 border-dashed border-gray-300 my-3"></div>
          <p class="text-center text-sm text-gray-500">‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ üôè</p>
        </div>
        
        <div class="p-4 border-t flex gap-3">
          <button onclick="closeReceiptModal()" class="flex-1 py-3 bg-gray-200 text-gray-700 rounded-xl font-medium hover:bg-gray-300 transition-all">
            ‡∏õ‡∏¥‡∏î
          </button>
          <button onclick="printReceipt()" class="flex-1 py-3 btn-primary text-white rounded-xl font-bold shadow-lg hover:shadow-xl transition-all">
            üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå
          </button>
        </div>
      </div>
    </div>
    
    <!-- Toast -->
    <div id="toast" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-xl shadow-lg hidden z-50">
      <span id="toast-message">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</span>
    </div>
    
    <!-- Loading -->
    <div id="loading" class="fixed inset-0 bg-black/30 z-50 hidden flex items-center justify-center">
      <div class="bg-white rounded-2xl p-6 shadow-2xl flex flex-col items-center gap-3">
        <div class="w-12 h-12 border-4 border-indigo-200 border-t-indigo-600 rounded-full animate-spin"></div>
        <p class="text-gray-600 font-medium">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
      </div>
    </div>
  </div>

  <script>
    // ==================== Configuration ====================
    const API_URL = 'https://script.google.com/macros/s/AKfycbxRKqSP-YaGZ3pfrlXdhXcBzA-Ycm-6ztU8yzcy9RhOLnsgm4MTclB-IATSpzL8u7NMng/exec';
    
    const defaultConfig = {
      store_name: '‡∏ä‡∏¥‡∏Å‡∏ä‡∏¥‡∏Å‡πÄ‡∏Å‡πâ‡∏ô‡∏â‡∏µ‡∏Å',
      store_phone: '',
      promptpay_number: '',
      promptpay_qr: ''
    };
    
    let config = { ...defaultConfig };
    let products = [];
    let cart = [];
    let sales = [];
    let currentTab = 'sell';
    let saleType = 'store';
    let currentPaymentMethod = 'cash';
    let todayQueue = 1;
    
    // ==================== Element SDK ====================
    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange: async (newConfig) => {
          config = { ...defaultConfig, ...newConfig };
          updateUI();
        },
        mapToCapabilities: (c) => ({
          recolorables: [],
          borderables: [],
          fontEditable: undefined,
          fontSizeable: undefined
        }),
        mapToEditPanelValues: (c) => new Map([
          ['store_name', c.store_name || defaultConfig.store_name],
          ['store_phone', c.store_phone || defaultConfig.store_phone],
          ['promptpay_number', c.promptpay_number || defaultConfig.promptpay_number]
        ])
      });
    }
    
    function updateUI() {
      document.getElementById('header-store-name').textContent = config.store_name;
      document.getElementById('receipt-store-name').textContent = config.store_name;
      document.getElementById('receipt-store-phone').textContent = config.store_phone;
      if (config.promptpay_number) {
        document.getElementById('promptpay-display').textContent = `‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå: ${config.promptpay_number}`;
      }
    }
    
    // ==================== API Functions ====================
    async function apiRequest(action, data = {}) {
      showLoading();
      try {
        const response = await fetch(API_URL, {
          method: 'POST',
          mode: 'cors',
          headers: { 'Content-Type': 'text/plain' },
          body: JSON.stringify({ action, ...data })
        });
        const result = await response.json();
        hideLoading();
        return result;
      } catch (error) {
        hideLoading();
        console.error('API Error:', error);
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠', 'error');
        return { success: false, error: error.message };
      }
    }
    
    // ==================== Products ====================
    async function loadProducts() {
      const result = await apiRequest('getProducts');
      if (result.success) {
        products = result.data || [];
        renderProducts();
        renderStockTable();
        updateCategoryFilter();
      }
    }
    
    function renderProducts() {
      const grid = document.getElementById('products-grid');
      const searchTerm = document.getElementById('search-product').value.toLowerCase();
      const category = document.getElementById('category-filter').value;
      
      const filtered = products.filter(p => {
        const matchSearch = p.name.toLowerCase().includes(searchTerm) || 
                          (p.barcode && p.barcode.includes(searchTerm));
        const matchCategory = !category || p.category === category;
        return matchSearch && matchCategory && p.stock > 0;
      });
      
      if (filtered.length === 0) {
        grid.innerHTML = `
          <div class="col-span-full text-center py-12 text-gray-500">
            <span class="text-6xl block mb-4">üì¶</span>
            <p class="text-lg">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</p>
          </div>
        `;
        return;
      }
      
      grid.innerHTML = filtered.map(p => `
    <div class="product-card bg-white rounded-2xl shadow-sm hover:shadow-xl overflow-hidden cursor-pointer border border-gray-100 group" onclick="addToCart('${p.id}')">
      <div class="aspect-square bg-gray-50 flex items-center justify-center overflow-hidden">
        ${p.image 
          ? `<img src="${p.image}" alt="${p.name}" class="group-hover:scale-110 transition-transform duration-500">` 
          : '<span class="text-4xl">üì¶</span>'
        }
        <div class="absolute top-2 right-2 bg-white/90 backdrop-blur px-2 py-1 rounded-lg shadow-sm">
           <span class="text-indigo-600 font-bold text-xs">‡∏ø${formatNumber(p.price)}</span>
        </div>
      </div>
      
      <div class="p-3 flex flex-col justify-between flex-1">
        <h4 class="font-medium text-gray-800 line-clamp-2 text-sm leading-snug mb-2">${p.name}</h4>
        <div class="flex justify-between items-center mt-auto">
          
        </div>
      </div>
    </div>
  `).join('');
}
    
    function renderStockTable() {
      const tbody = document.getElementById('stock-table');
      
      if (products.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="6" class="text-center py-12 text-gray-500">
              <span class="text-5xl block mb-3">üì¶</span>
              <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</p>
            </td>
          </tr>
        `;
        return;
      }
      
      tbody.innerHTML = products.map(p => `
        <tr class="hover:bg-gray-50 transition-colors">
          <td class="px-4 py-3">
            <div class="w-12 h-12 bg-gray-100 rounded-lg flex items-center justify-center overflow-hidden">
              ${p.image ? `<img src="${p.image}" alt="${p.name}" class="w-full h-full object-cover" loading="lazy" onerror="this.parentElement.innerHTML='üì¶'">` : 'üì¶'}
            </div>
          </td>
          <td class="px-4 py-3 font-medium">${p.name}</td>
          <td class="px-4 py-3 text-gray-500 text-sm">${p.barcode || '-'}</td>
          <td class="px-4 py-3 text-right font-medium text-indigo-600">‡∏ø${formatNumber(p.price)}</td>
          <td class="px-4 py-3 text-right">
            <span class="px-2 py-1 rounded-full text-sm ${p.stock < 5 ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-600'}">
              ${p.stock}
            </span>
          </td>
          <td class="px-4 py-3">
            <div class="flex justify-center gap-2">
              <button onclick="editProduct('${p.id}')" class="p-2 bg-blue-100 text-blue-600 rounded-lg hover:bg-blue-200 transition-all" title="‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç">
                ‚úèÔ∏è
              </button>
              <button onclick="deleteProduct('${p.id}')" class="p-2 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 transition-all" title="‡∏•‡∏ö">
                üóëÔ∏è
              </button>
            </div>
          </td>
        </tr>
      `).join('');
    }
    
    function updateCategoryFilter() {
      const categories = [...new Set(products.map(p => p.category).filter(Boolean))];
      const select = document.getElementById('category-filter');
      select.innerHTML = '<option value="">üìÅ ‡∏ó‡∏∏‡∏Å‡∏´‡∏°‡∏ß‡∏î</option>' +
        categories.map(c => `<option value="${c}">${c}</option>`).join('');
    }
    
    function filterProducts(term) {
      renderProducts();
    }
    
    function filterByCategory(category) {
      renderProducts();
    }
    
    function showAddProductModal() {
      document.getElementById('product-modal-title').textContent = '‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà';
      document.getElementById('product-form').reset();
      document.getElementById('product-id').value = '';
      document.getElementById('product-image').value = '';
      document.getElementById('product-image-preview').innerHTML = 'üì∑';
      document.getElementById('product-modal').classList.remove('hidden');
    }
    
    function editProduct(id) {
      const product = products.find(p => p.id === id);
      if (!product) return;
      
      document.getElementById('product-modal-title').textContent = '‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤';
      document.getElementById('product-id').value = product.id;
      document.getElementById('product-name').value = product.name;
      document.getElementById('product-barcode').value = product.barcode || '';
      document.getElementById('product-price').value = product.price;
      document.getElementById('product-stock').value = product.stock;
      document.getElementById('product-category').value = product.category || '';
      document.getElementById('product-image').value = product.image || '';
      
      const preview = document.getElementById('product-image-preview');
      if (product.image) {
        preview.innerHTML = `<img src="${product.image}" class="w-full h-full object-cover rounded-xl" loading="lazy">`;
      } else {
        preview.innerHTML = 'üì∑';
      }
      
      document.getElementById('product-modal').classList.remove('hidden');
    }
    
    function closeProductModal() {
      document.getElementById('product-modal').classList.add('hidden');
    }
    
    function previewProductImage(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = (e) => {
        const base64 = e.target.result;
        document.getElementById('product-image').value = base64;
        document.getElementById('product-image-preview').innerHTML = 
          `<img src="${base64}" class="w-full h-full object-cover rounded-xl">`;
      };
      reader.readAsDataURL(file);
    }
    
    async function saveProduct(event) {
      event.preventDefault();
      
      const id = document.getElementById('product-id').value;
      const productData = {
        name: document.getElementById('product-name').value,
        barcode: document.getElementById('product-barcode').value,
        price: parseFloat(document.getElementById('product-price').value),
        stock: parseInt(document.getElementById('product-stock').value),
        category: document.getElementById('product-category').value,
        image: document.getElementById('product-image').value
      };
      
      let result;
      if (id) {
        result = await apiRequest('updateProduct', { id, ...productData });
      } else {
        result = await apiRequest('addProduct', productData);
      }
      
      if (result.success) {
        showToast(id ? '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à' : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        closeProductModal();
        await loadProducts();
      } else {
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + (result.error || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ'), 'error');
      }
    }
    
    async function deleteProduct(id) {
      const product = products.find(p => p.id === id);
      if (!product) return;
      
      // Custom inline confirmation
      const btn = event.target;
      if (btn.dataset.confirming !== 'true') {
        btn.dataset.confirming = 'true';
        btn.textContent = '‚ùì';
        btn.title = '‡∏Ñ‡∏•‡∏¥‡∏Å‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô';
        setTimeout(() => {
          btn.dataset.confirming = 'false';
          btn.textContent = 'üóëÔ∏è';
          btn.title = '‡∏•‡∏ö';
        }, 3000);
        return;
      }
      
      const result = await apiRequest('deleteProduct', { id });
      if (result.success) {
        showToast('‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
        await loadProducts();
      }
    }
    
    // ==================== Cart ====================
    function addToCart(productId) {
      const product = products.find(p => p.id === productId);
      if (!product || product.stock <= 0) {
        showToast('‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏°‡∏î', 'error');
        return;
      }
      
      const existingItem = cart.find(item => item.productId === productId);
      if (existingItem) {
        if (existingItem.qty >= product.stock) {
          showToast('‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏û‡∏≠', 'error');
          return;
        }
        existingItem.qty++;
      } else {
        cart.push({
          productId,
          name: product.name,
          price: product.price,
          qty: 1
        });
      }
      
      updateCartUI();
      showToast(`‡πÄ‡∏û‡∏¥‡πà‡∏° ${product.name} ‡πÅ‡∏•‡πâ‡∏ß`);
    }
    
    function updateCartItem(productId, change) {
      const item = cart.find(i => i.productId === productId);
      const product = products.find(p => p.id === productId);
      
      if (!item) return;
      
      item.qty += change;
      
      if (item.qty <= 0) {
        cart = cart.filter(i => i.productId !== productId);
      } else if (product && item.qty > product.stock) {
        item.qty = product.stock;
        showToast('‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏û‡∏≠', 'error');
      }
      
      updateCartUI();
    }
    
    function removeFromCart(productId) {
      cart = cart.filter(i => i.productId !== productId);
      updateCartUI();
    }
    
    function clearCart() {
      cart = [];
      updateCartUI();
      showToast('‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß');
    }
    
    function updateCartUI() {
      const cartItems = document.getElementById('cart-items');
      const cartCount = document.getElementById('cart-count');
      const cartTotal = document.getElementById('cart-total');
      
      const totalItems = cart.reduce((sum, item) => sum + item.qty, 0);
      const totalPrice = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
      
      cartCount.textContent = totalItems;
      cartCount.classList.toggle('hidden', totalItems === 0);
      cartTotal.textContent = `‡∏ø${formatNumber(totalPrice)}`;
      
      if (cart.length === 0) {
        cartItems.innerHTML = `
          <div class="text-center py-12 text-gray-500">
            <span class="text-5xl block mb-3">üõí</span>
            <p>‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤</p>
          </div>
        `;
        return;
      }
      
      cartItems.innerHTML = cart.map(item => `
        <div class="bg-gray-50 rounded-xl p-3 flex items-center gap-3">
          <div class="flex-1">
            <p class="font-medium text-gray-800">${item.name}</p>
            <p class="text-sm text-indigo-600 font-medium">‡∏ø${formatNumber(item.price)} x ${item.qty} = ‡∏ø${formatNumber(item.price * item.qty)}</p>
          </div>
          <div class="flex items-center gap-1">
            <button onclick="updateCartItem('${item.productId}', -1)" class="w-8 h-8 bg-gray-200 rounded-lg hover:bg-gray-300 transition-all font-bold">-</button>
            <span class="w-8 text-center font-medium">${item.qty}</span>
            <button onclick="updateCartItem('${item.productId}', 1)" class="w-8 h-8 bg-gray-200 rounded-lg hover:bg-gray-300 transition-all font-bold">+</button>
            <button onclick="removeFromCart('${item.productId}')" class="w-8 h-8 bg-red-100 text-red-600 rounded-lg hover:bg-red-200 transition-all ml-2">‚úï</button>
          </div>
        </div>
      `).join('');
    }
    
    function toggleCart() {
      const sidebar = document.getElementById('cart-sidebar');
      const overlay = document.getElementById('cart-overlay');
      const isOpen = !sidebar.classList.contains('translate-x-full');
      
      if (isOpen) {
        sidebar.classList.add('translate-x-full');
        overlay.classList.add('hidden');
      } else {
        sidebar.classList.remove('translate-x-full');
        overlay.classList.remove('hidden');
      }
    }
    
    function setSaleType(type) {
      saleType = type;
      document.getElementById('sale-type-store').classList.toggle('bg-indigo-100', type === 'store');
      document.getElementById('sale-type-store').classList.toggle('text-indigo-700', type === 'store');
      document.getElementById('sale-type-store').classList.toggle('border-indigo-400', type === 'store');
      document.getElementById('sale-type-store').classList.toggle('bg-gray-100', type !== 'store');
      document.getElementById('sale-type-store').classList.toggle('text-gray-600', type !== 'store');
      document.getElementById('sale-type-store').classList.toggle('border-transparent', type !== 'store');
      
      document.getElementById('sale-type-online').classList.toggle('bg-indigo-100', type === 'online');
      document.getElementById('sale-type-online').classList.toggle('text-indigo-700', type === 'online');
      document.getElementById('sale-type-online').classList.toggle('border-indigo-400', type === 'online');
      document.getElementById('sale-type-online').classList.toggle('bg-gray-100', type !== 'online');
      document.getElementById('sale-type-online').classList.toggle('text-gray-600', type !== 'online');
      document.getElementById('sale-type-online').classList.toggle('border-transparent', type !== 'online');
    }
    
    // ==================== Checkout ====================
    function checkout(method) {
      if (cart.length === 0) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô', 'error');
        return;
      }
      
      currentPaymentMethod = method;
      const total = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
      
      document.getElementById('payment-amount').textContent = `‡∏ø${formatNumber(total)}`;
      
      if (method === 'cash') {
        document.getElementById('payment-header').className = 'p-5 border-b bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-t-2xl';
        document.getElementById('payment-header').innerHTML = '<h3 class="text-xl font-bold">üíµ ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</h3>';
        document.getElementById('cash-section').classList.remove('hidden');
        document.getElementById('promptpay-section').classList.add('hidden');
        document.getElementById('cash-received').value = '';
        document.getElementById('change-amount').textContent = '‡∏ø0';
      } else {
        document.getElementById('payment-header').className = 'p-5 border-b bg-gradient-to-r from-blue-500 to-indigo-500 text-white rounded-t-2xl';
        document.getElementById('payment-header').innerHTML = '<h3 class="text-xl font-bold">üì± ‡∏ä‡∏≥‡∏£‡∏∞‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå</h3>';
        document.getElementById('cash-section').classList.add('hidden');
        document.getElementById('promptpay-section').classList.remove('hidden');
        
        // Show existing QR if available
        if (config.promptpay_qr) {
          document.getElementById('qr-image-container').innerHTML = 
            `<img src="${config.promptpay_qr}" class="w-full h-full object-contain">`;
        }
      }
      
      document.getElementById('payment-modal').classList.remove('hidden');
    }
    
    function calculateChange() {
      const total = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
      const received = parseFloat(document.getElementById('cash-received').value) || 0;
      const change = received - total;
      document.getElementById('change-amount').textContent = `‡∏ø${formatNumber(Math.max(0, change))}`;
    }
    
    function uploadQRCode(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = (e) => {
        const base64 = e.target.result;
        config.promptpay_qr = base64;
        document.getElementById('qr-image-container').innerHTML = 
          `<img src="${base64}" class="w-full h-full object-contain">`;
        if (window.elementSdk) {
          window.elementSdk.setConfig({ promptpay_qr: base64 });
        }
      };
      reader.readAsDataURL(file);
    }
    
    function closePaymentModal() {
      document.getElementById('payment-modal').classList.add('hidden');
    }
    
    async function confirmPayment() {
      const total = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
      let cashReceived = 0;
      let change = 0;
      
      if (currentPaymentMethod === 'cash') {
        cashReceived = parseFloat(document.getElementById('cash-received').value) || 0;
        if (cashReceived < total) {
          showToast('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠', 'error');
          return;
        }
        change = cashReceived - total;
      }
      
      // Get today's queue number
      const today = new Date().toISOString().split('T')[0];
      const storedDate = localStorage.getItem('pos_queue_date');
      if (storedDate !== today) {
        localStorage.setItem('pos_queue_date', today);
        localStorage.setItem('pos_queue_number', '1');
        todayQueue = 1;
      } else {
        todayQueue = parseInt(localStorage.getItem('pos_queue_number') || '1');
      }
      
      const queueNumber = String(todayQueue).padStart(3, '0');
      
      // Prepare sale data
      const saleData = {
        queue: queueNumber,
        date: new Date().toISOString(),
        items: cart.map(item => ({
          productId: item.productId,
          name: item.name,
          price: item.price,
          qty: item.qty
        })),
        total,
        paymentMethod: currentPaymentMethod,
        saleType,
        cashReceived: currentPaymentMethod === 'cash' ? cashReceived : 0,
        change: currentPaymentMethod === 'cash' ? change : 0
      };
      
      // Save sale to API
      const result = await apiRequest('addSale', saleData);
      
      if (result.success) {
        // Update queue number
        todayQueue++;
        localStorage.setItem('pos_queue_number', String(todayQueue));
        
        // Close payment modal and cart
        closePaymentModal();
        toggleCart();
        
        // Show receipt
        showReceipt(saleData);
        
        // Update stock locally (will be synced via API)
        cart.forEach(item => {
          const product = products.find(p => p.id === item.productId);
          if (product) {
            product.stock -= item.qty;
          }
        });
        
        // Clear cart and reload
        cart = [];
        updateCartUI();
        renderProducts();
        
        showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      } else {
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + (result.error || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ'), 'error');
      }
    }
    
    function showReceipt(saleData) {
      document.getElementById('receipt-date').textContent = new Date(saleData.date).toLocaleString('th-TH');
      document.getElementById('receipt-queue').textContent = `#${saleData.queue}`;
      document.getElementById('receipt-sale-type').textContent = saleData.saleType === 'store' ? 'üè™ ‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô' : 'üåê ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå';
      
      document.getElementById('receipt-items').innerHTML = saleData.items.map(item => `
        <div class="flex justify-between">
          <span>${item.name} x${item.qty}</span>
          <span>‡∏ø${formatNumber(item.price * item.qty)}</span>
        </div>
      `).join('');
      
      document.getElementById('receipt-total').textContent = `‡∏ø${formatNumber(saleData.total)}`;
      document.getElementById('receipt-payment-method').textContent = 
        saleData.paymentMethod === 'cash' ? 'üíµ ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î' : 'üì± ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå';
      
      if (saleData.paymentMethod === 'cash') {
        document.getElementById('receipt-cash-info').classList.remove('hidden');
        document.getElementById('receipt-cash-received').textContent = `‡∏ø${formatNumber(saleData.cashReceived)}`;
        document.getElementById('receipt-change').textContent = `‡∏ø${formatNumber(saleData.change)}`;
      } else {
        document.getElementById('receipt-cash-info').classList.add('hidden');
      }
      
      document.getElementById('receipt-modal').classList.remove('hidden');
      
      // Auto print
      setTimeout(() => printReceipt(), 500);
    }
    
    function closeReceiptModal() {
      document.getElementById('receipt-modal').classList.add('hidden');
    }
    
    function printReceipt() {
      window.print();
    }
    
    // ==================== Sales History ====================
    async function loadSalesHistory() {
      const dateInput = document.getElementById('history-date');
      const date = dateInput.value || new Date().toISOString().split('T')[0];
      
      const result = await apiRequest('getSales', { date });
      
      if (result.success) {
        sales = result.data || [];
        renderSalesHistory();
        updateTodaySummary();
      }
    }
    
    function renderSalesHistory() {
      const list = document.getElementById('sales-list');
      
      if (sales.length === 0) {
        list.innerHTML = `
          <div class="text-center py-12 text-gray-500">
            <span class="text-5xl block mb-3">üìä</span>
            <p>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</p>
          </div>
        `;
        return;
      }
      
      list.innerHTML = sales.map(sale => `
        <div class="p-4 hover:bg-gray-50 transition-colors cursor-pointer" onclick="showSaleReceipt('${sale.id}')">
          <div class="flex justify-between items-start">
            <div>
              <span class="text-lg font-bold text-indigo-600">#${sale.queue}</span>
              <span class="ml-2 px-2 py-0.5 rounded-full text-xs ${sale.saleType === 'store' ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'}">
                ${sale.saleType === 'store' ? 'üè™ ‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô' : 'üåê ‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå'}
              </span>
              <p class="text-sm text-gray-500 mt-1">${new Date(sale.date).toLocaleString('th-TH')}</p>
              <p class="text-xs text-gray-400">${sale.items?.length || 0} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‚Ä¢ ${sale.paymentMethod === 'cash' ? 'üíµ ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î' : 'üì± ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå'}</p>
            </div>
            <div class="text-right">
              <p class="text-lg font-bold text-green-600">‡∏ø${formatNumber(sale.total)}</p>
              <button class="text-xs text-indigo-600 hover:underline mt-1">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</button>
            </div>
          </div>
        </div>
      `).join('');
    }
    
    function updateTodaySummary() {
      const todaySales = sales.filter(s => {
        const saleDate = new Date(s.date).toDateString();
        return saleDate === new Date().toDateString();
      });
      
      const totalSales = todaySales.reduce((sum, s) => sum + (s.total || 0), 0);
      const totalItems = todaySales.reduce((sum, s) => sum + (s.items?.reduce((is, i) => is + i.qty, 0) || 0), 0);
      
      document.getElementById('today-sales').textContent = `‡∏ø${formatNumber(totalSales)}`;
      document.getElementById('today-bills').textContent = todaySales.length;
      document.getElementById('today-items').textContent = totalItems;
    }
    
    function showSaleReceipt(saleId) {
      const sale = sales.find(s => s.id === saleId);
      if (!sale) return;
      
      showReceipt(sale);
    }
    
    // ==================== Tabs ====================
    function switchTab(tab) {
      currentTab = tab;
      
      // Update tab buttons
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('bg-white', 'shadow', 'text-indigo-600');
        btn.classList.add('text-gray-600');
      });
      document.getElementById(`tab-${tab}`).classList.add('bg-white', 'shadow', 'text-indigo-600');
      document.getElementById(`tab-${tab}`).classList.remove('text-gray-600');
      
      // Update pages
      document.querySelectorAll('.page').forEach(page => page.classList.add('hidden'));
      document.getElementById(`page-${tab}`).classList.remove('hidden');
      
      // Load data for specific tabs
      if (tab === 'history') {
        document.getElementById('history-date').value = new Date().toISOString().split('T')[0];
        loadSalesHistory();
      }
    }
    
    // ==================== Utilities ====================
    function formatNumber(num) {
      return Number(num || 0).toLocaleString('th-TH', { minimumFractionDigits: 0, maximumFractionDigits: 2 });
    }
    
    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      const toastMessage = document.getElementById('toast-message');
      
      toastMessage.textContent = message;
      toast.className = `fixed bottom-4 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-xl shadow-lg z-50 ${
        type === 'error' ? 'bg-red-600 text-white' : 'bg-gray-800 text-white'
      }`;
      toast.classList.remove('hidden');
      
      setTimeout(() => toast.classList.add('hidden'), 3000);
    }
    
    function showLoading() {
      document.getElementById('loading').classList.remove('hidden');
    }
    
    function hideLoading() {
      document.getElementById('loading').classList.add('hidden');
    }
    
    // ==================== Init ====================
    async function init() {
      updateUI();
      
      // Set today's date for history
      document.getElementById('history-date').value = new Date().toISOString().split('T')[0];
      
      // Load queue number
      const today = new Date().toISOString().split('T')[0];
      const storedDate = localStorage.getItem('pos_queue_date');
      if (storedDate === today) {
        todayQueue = parseInt(localStorage.getItem('pos_queue_number') || '1');
      } else {
        localStorage.setItem('pos_queue_date', today);
        localStorage.setItem('pos_queue_number', '1');
        todayQueue = 1;
      }
      
      // Load products
      await loadProducts();
      
      updateCartUI();
    }
    
    init();
  </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9ceea15ff1edafe4',t:'MTc3MTI2MTUzMy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>


