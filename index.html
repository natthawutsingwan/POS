<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POS System - ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏≤‡∏¢‡∏´‡∏ô‡πâ‡∏≤‡∏£‡πâ‡∏≤‡∏ô (‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
        body {
            font-family: 'Sarabun', sans-serif;
        }
        .receipt-print {
            font-family: 'Sarabun', sans-serif;
            font-size: 14px;
            line-height: 1.5;
            width: 21cm; /* A4 width */
            margin: 0 auto;
            padding: 1cm;
        }
        @media print {
            body * { visibility: hidden; }
            #receipt-print, #receipt-print * { visibility: visible; }
            #receipt-print { position: absolute; left: 0; top: 0; width: 100%; }
        }
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }
        .modal-overlay.show .modal-content {
            transform: scale(1);
        }
        /* Mini Bar Chart Style */
        .mini-bar {
            position: relative;
            height: 12px;
            background-color: #e0e0e0;
            border-radius: 6px;
            overflow: hidden;
            width: 100%;
            margin-top: 4px;
        }
        .mini-bar-fill {
            height: 100%;
            border-radius: 6px;
            transition: width 0.5s ease;
        }
    </style>
</head>
<body class="bg-gray-50">
    <nav class="bg-blue-600 text-white p-4 shadow-lg">
        <div class="flex justify-between items-center">
            <h1 class="text-2xl font-bold">üè™ C-POS </h1>
            <div class="flex space-x-2">
                <button onclick="showPage('dashboard')" class="bg-blue-500 hover:bg-blue-400 px-4 py-2 rounded-lg transition-colors">üìä ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</button>
                <button onclick="showPage('sales')" class="bg-blue-500 hover:bg-blue-400 px-4 py-2 rounded-lg transition-colors">üõí ‡∏Ç‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
                <button onclick="showPage('history')" class="bg-blue-500 hover:bg-blue-400 px-4 py-2 rounded-lg transition-colors">üìä ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</button>
                <button onclick="showPage('stock')" class="bg-blue-500 hover:bg-blue-400 px-4 py-2 rounded-lg transition-colors">üì¶ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πá‡∏≠‡∏Å</button>
                <button onclick="showPage('stock-history')" class="bg-blue-500 hover:bg-blue-400 px-4 py-2 rounded-lg transition-colors">üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏™‡∏ï‡πá‡∏≠‡∏Å</button>
                <button onclick="showPage('finance')" class="bg-blue-500 hover:bg-blue-400 px-4 py-2 rounded-lg transition-colors">üí∞ ‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô</button>
                <button onclick="showPage('settings')" class="bg-blue-500 hover:bg-blue-400 px-4 py-2 rounded-lg transition-colors">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
            </div>
        </div>
    </nav>
    <div id="modal-overlay" class="modal-overlay hidden">
        <div class="modal-content bg-white rounded-xl shadow-2xl max-w-md w-full p-6">
            <div id="modal-icon" class="text-6xl text-center mb-4">‚è≥</div>
            <div id="modal-title" class="text-xl font-semibold text-center mb-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
            <div id="modal-message" class="text-gray-700 text-center mb-4">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà</div>
            <div id="modal-buttons" class="flex space-x-2 justify-center"></div>
        </div>
    </div>
    <div id="receipt-print" class="receipt-print hidden"></div>

    <div id="dashboard-page" class="page p-6 hidden">
        <h2 class="text-2xl font-bold mb-6">üìä ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <div class="bg-white p-6 rounded-xl shadow-md flex items-center space-x-4">
                <div class="bg-blue-100 p-3 rounded-full">
                    <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v.01"></path></svg>
                </div>
                <div>
                    <p class="text-sm text-gray-500">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p>
                    <p id="dashboard-daily-sales" class="text-2xl font-bold">‡∏ø0.00</p>
                </div>
            </div>
             <div class="bg-white p-6 rounded-xl shadow-md flex items-center space-x-4">
                <div class="bg-green-100 p-3 rounded-full">
                     <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
                </div>
                <div>
                    <p class="text-sm text-gray-500">‡∏Å‡∏≥‡πÑ‡∏£‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p>
                    <p id="dashboard-daily-profit" class="text-2xl font-bold">‡∏ø0.00</p>
                </div>
            </div>
             <div class="bg-white p-6 rounded-xl shadow-md flex items-center space-x-4">
                <div class="bg-indigo-100 p-3 rounded-full">
                    <svg class="w-8 h-8 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002-2h2a2 2 0 002 2M9 5v1.447A1 1 0 0110.553 7.5H13.45a1 1 0 01.553.947V10m-4 0v4m0 0v4m0-4h4m-4 0H6"></path></svg>
                </div>
                <div>
                    <p class="text-sm text-gray-500">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ö‡∏¥‡∏•‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p>
                    <p id="dashboard-daily-transactions" class="text-2xl font-bold">0</p>
                </div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-md flex items-center space-x-4">
                <div class="bg-yellow-100 p-3 rounded-full">
                    <svg class="w-8 h-8 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path></svg>
                </div>
                <div>
                    <p class="text-sm text-gray-500">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                    <p id="dashboard-total-products" class="text-2xl font-bold">0</p>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-6">
            <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-md">
                <h3 class="text-lg font-semibold mb-4">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ 7 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h3>
                <canvas id="salesChart"></canvas>
            </div>
            <div class="space-y-6">
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h3 class="text-lg font-semibold mb-2">‚≠ê ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ)</h3>
                    <div id="dashboard-best-sellers" class="space-y-3"></div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h3 class="text-lg font-semibold mb-2">‚ö†Ô∏è ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ï‡πà‡∏≥</h3>
                    <div id="dashboard-low-stock" class="space-y-3"></div>
                </div>
            </div>
        </div>
    </div>


    <div id="sales-page" class="page p-6">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2">
                <div id="low-stock-alert" class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-4 rounded hidden">
                    <p class="font-semibold">‚ö†Ô∏è ‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ï‡πà‡∏≥!</p>
                    <p id="low-stock-list"></p>
                </div>
                <div class="bg-white rounded-xl shadow-md p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
                        <button onclick="refreshProducts()" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
                    </div>
                    <input type="text" id="product-search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠ ‡∏£‡∏´‡∏±‡∏™ ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏¥‡∏á‡∏ö‡∏≤‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î..." class="w-full p-3 border border-gray-300 rounded-lg mb-4">
                    
                    <div id="category-filters" class="flex flex-wrap gap-2 mb-4">
                        <p class="text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà...</p>
                    </div>
                    
                    <div id="loading-products" class="text-center py-4 hidden">
                        <p class="text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
                    </div>
                    <div id="product-grid" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4"></div>
                </div>
            </div>
            <div>
                <div class="bg-white rounded-xl shadow-md p-6 sticky top-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-semibold">üõí ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
                        <button onclick="clearCart()" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-lg text-xs font-semibold">üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</button>
                    </div>

                    <div class="flex space-x-2 mb-3">
                        <button onclick="holdCart()" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white py-2 rounded-lg text-sm font-semibold">‚è∏Ô∏è ‡∏û‡∏±‡∏Å‡∏ö‡∏¥‡∏•</button>
                        <button onclick="showHeldCarts()" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg text-sm font-semibold relative">
                            ‚ñ∂Ô∏è ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ö‡∏¥‡∏•
                            <span id="held-cart-count" class="absolute -top-2 -right-2 bg-red-600 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">0</span>
                        </button>
                    </div>

                    <div id="cart-items" class="space-y-2 mb-4 max-h-64 overflow-y-auto">
                        </div>
                    <div class="border-t pt-4">

                        <div class="space-y-2 text-sm mb-4">
                            <div class="flex justify-between"><span>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°:</span> <span id="summary-subtotal">‡∏ø0.00</span></div>
                            <div class="flex justify-between items-center">
                                <span>‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î:</span>
                                <div class="flex items-center space-x-1">
                                    <input type="number" id="discount-value" class="w-20 p-1 border rounded text-right" value="0">
                                    <select id="discount-type" class="p-1 border rounded">
                                        <option value="percent">%</option>
                                        <option value="amount">‡∏ö‡∏≤‡∏ó</option>
                                    </select>
                                </div>
                            </div>
                             <div class="flex justify-between text-red-600"><span>‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ:</span> <span id="summary-discount">‡∏ø0.00</span></div>
                            <div class="flex justify-between font-semibold"><span>‡∏¢‡∏≠‡∏î‡∏´‡∏•‡∏±‡∏á‡∏´‡∏±‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î:</span> <span id="summary-after-discount">‡∏ø0.00</span></div>
                            <div class="flex justify-between items-center">
                                <span>VAT (<span id="vat-rate-display">7</span>%):</span>
                                <label class="inline-flex items-center cursor-pointer">
                                  <input type="checkbox" id="vat-toggle" class="sr-only peer">
                                  <div class="relative w-11 h-6 bg-gray-200 rounded-full peer peer-focus:ring-4 peer-focus:ring-blue-300 peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                </label>
                            </div>
                            <div class="flex justify-between"><span>‡∏¢‡∏≠‡∏î VAT:</span> <span id="summary-vat">‡∏ø0.00</span></div>
                        </div>

                        <div class="border-t-2 border-dashed pt-2">
                             <div class="flex justify-between text-xl font-bold mb-4">
                                <span>‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥:</span>
                                <span id="total-amount">‡∏ø0.00</span>
                            </div>
                        </div>


                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô:</label>
                            <select id="payment-method" class="w-full p-2 border border-gray-300 rounded-lg">
                                <option value="cash">üíµ ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</option>
                                <option value="qr">üì± QR Code</option>
                            </select>
                        </div>
                        <div id="cash-payment" class="mb-4">
                            <label class="block text-sm font-medium mb-1">‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö:</label>
                            <div class="grid grid-cols-4 gap-2 my-2">
                                <button onclick="setReceivedCash(100)" class="bg-gray-200 hover:bg-gray-300 py-1 rounded">100</button>
                                <button onclick="setReceivedCash(500)" class="bg-gray-200 hover:bg-gray-300 py-1 rounded">500</button>
                                <button onclick="setReceivedCash(1000)" class="bg-gray-200 hover:bg-gray-300 py-1 rounded">1000</button>
                                <button onclick="setReceivedCash('exact')" class="bg-blue-200 hover:bg-blue-300 py-1 rounded">‡∏û‡∏≠‡∏î‡∏µ</button>
                            </div>
                            <input type="number" id="cash-received" placeholder="0.00" class="w-full p-2 border border-gray-300 rounded-lg">
                            <div class="flex justify-between mt-2">
                                <span>‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏≠‡∏ô:</span>
                                <span id="change-amount">‡∏ø0.00</span>
                            </div>
                        </div>
                        <button onclick="processPayment()" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg font-semibold transition-colors mb-2">‚úÖ ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</button>
                        <button onclick="printLastReceipt()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg font-semibold transition-colors">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏ã‡πâ‡∏≥</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="stock-page" class="page p-6 hidden">
        <div id="stock-login" class="max-w-md mx-auto bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold mb-4 text-center">üîí ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πá‡∏≠‡∏Å</h2>
            <input type="password" id="stock-password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" class="w-full p-3 border border-gray-300 rounded-lg mb-4">
            <button onclick="checkStockPassword()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-semibold">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
        <div id="stock-main" class="hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">üì¶ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h2>
                <button onclick="openAddProductModal()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-semibold">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6">
                <div id="stock-list"></div>
            </div>
        </div>
    </div>
    <div id="stock-history-page" class="page p-6 hidden">
        <div id="stock-history-login" class="max-w-md mx-auto bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold mb-4 text-center">üîí ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏™‡∏ï‡πá‡∏≠‡∏Å</h2>
            <input type="password" id="stock-history-password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" class="w-full p-3 border border-gray-300 rounded-lg mb-4">
            <button onclick="checkStockHistoryPassword()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-semibold">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
        <div id="stock-history-main" class="hidden">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4">üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏™‡∏ï‡πá‡∏≠‡∏Å</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="md:col-span-2">
                        <div class="flex space-x-2">
                            <select id="stock-history-month-filter" class="p-2 border border-gray-300 rounded-lg text-sm flex-1">
                                <option value="1">‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°</option>
                                <option value="2">‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå</option>
                                <option value="3">‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°</option>
                                <option value="4">‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô</option>
                                <option value="5">‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°</option>
                                <option value="6">‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô</option>
                                <option value="7">‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°</option>
                                <option value="8">‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°</option>
                                <option value="9">‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô</option>
                                <option value="10">‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°</option>
                                <option value="11">‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô</option>
                                <option value="12">‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°</option>
                            </select>
                            <select id="stock-history-year-filter" class="p-2 border border-gray-300 rounded-lg text-sm w-32">
                                </select>
                        </div>
                    </div>
                    <div class="flex items-start space-x-2">
                        <button onclick="openDateRangeModal('stock-history')" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå</button>
                        <button onclick="clearAllStockHistory()" class="flex-1 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-semibold">üóëÔ∏è ‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                    </div>
                </div>

                <div class="bg-gray-50 p-4 rounded-lg mb-6 border-l-4 border-gray-500">
                    <h3 class="text-lg font-semibold text-gray-800">‡∏™‡∏£‡∏∏‡∏õ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h3>
                    <div class="grid grid-cols-2 gap-4 mt-2 text-center">
                        <div class="bg-green-100 p-3 rounded-lg">
                            <h4 class="text-sm font-semibold text-green-800">‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h4>
                            <p class="text-2xl font-bold text-green-600" id="monthly-stock-in">0</p>
                            <span class="text-xs text-gray-600">‡∏ä‡∏¥‡πâ‡∏ô</span>
                        </div>
                         <div class="bg-red-100 p-3 rounded-lg">
                            <h4 class="text-sm font-semibold text-red-800">‡∏Ç‡∏≤‡∏¢/‡∏ï‡∏±‡∏î‡∏≠‡∏≠‡∏Å</h4>
                            <p class="text-2xl font-bold text-red-600" id="monthly-stock-out">0</p>
                            <span class="text-xs text-gray-600">‡∏ä‡∏¥‡πâ‡∏ô</span>
                        </div>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-2 text-left">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                <th class="px-4 py-2 text-left">‡πÄ‡∏ß‡∏•‡∏≤</th>
                                <th class="px-4 py-2 text-left">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                                <th class="px-4 py-2 text-left">‡∏£‡∏´‡∏±‡∏™</th>
                                <th class="px-4 py-2">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á</th>
                                <th class="px-4 py-2">‡πÄ‡∏î‡∏¥‡∏°‚Üí‡πÉ‡∏´‡∏°‡πà</th>
                                <th class="px-4 py-2 text-left">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•</th>
                            </tr>
                        </thead>
                        <tbody id="stock-history-body">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div id="history-page" class="page p-6 hidden">
        <div class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold mb-4">üìä ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</h2>
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
                <input type="date" id="sales-date-filter" class="p-2 border border-gray-300 rounded-lg">
                <input type="text" id="sales-history-search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠/‡∏£‡∏´‡∏±‡∏™" class="p-2 border border-gray-300 rounded-lg md:col-span-2">
                <button onclick="searchHistory()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold">üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button>
                <button onclick="openDateRangeModal('sales')" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-semibold">üìÖ ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
                <div class="bg-blue-50 p-4 rounded-lg border-l-4 border-blue-500">
                    <h3 class="text-lg font-semibold text-blue-800">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</h3>
                    <p class="text-2xl font-bold text-blue-600 mt-1" id="daily-sales">‡∏ø0.00</p>
                    <p class="text-sm text-gray-600" id="daily-count">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
                    <p class="text-lg font-bold text-green-600 mt-2" id="daily-profit">‡∏Å‡∏≥‡πÑ‡∏£: ‡∏ø0.00</p>
                    <div class="mt-3 border-t pt-2 space-y-2 text-sm text-blue-700" id="daily-product-summary">
                        <p class="text-gray-500">‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î...</p>
                    </div>
                </div>
                <div class="bg-green-50 p-4 rounded-lg border-l-4 border-green-500">
                    <h3 class="text-lg font-semibold text-green-800">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</h3>
                    <div class="flex space-x-2 mt-2">
                        <select id="month-filter" class="p-2 border border-gray-300 rounded-lg text-sm flex-1">
                            <option value="1">‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°</option>
                            <option value="2">‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå</option>
                            <option value="3">‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°</option>
                            <option value="4">‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô</option>
                            <option value="5">‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°</option>
                            <option value="6">‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô</option>
                            <option value="7">‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°</option>
                            <option value="8">‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°</option>
                            <option value="9">‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô</option>
                            <option value="10">‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°</option>
                            <option value="11">‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô</option>
                            <option value="12">‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°</option>
                        </select>
                        <select id="year-filter" class="p-2 border border-gray-300 rounded-lg text-sm w-32"></select>
                    </div>
                    <p class="text-2xl font-bold text-green-600 mt-3" id="monthly-sales">‡∏ø0.00</p>
                    <p class="text-sm text-gray-600" id="monthly-count">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>
                    <p class="text-lg font-bold text-green-600 mt-2" id="monthly-profit">‡∏Å‡∏≥‡πÑ‡∏£: ‡∏ø0.00</p>
                </div>
                <div class="bg-indigo-50 p-4 rounded-lg border-l-4 border-indigo-500 lg:col-span-1 md:col-span-2">
                     <h3 class="text-lg font-semibold text-indigo-800">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ)</h3>
                     <div class="mt-3 pt-2 space-y-2 text-sm text-indigo-700" id="monthly-product-summary">
                        <p class="text-gray-500">‡∏£‡∏≠‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î...</p>
                    </div>
                </div>
            </div>

            <div class="mb-4 flex space-x-2">
                <button onclick="printZReport()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-semibold">üìú ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏ß‡∏±‡∏ô</button>
                <button onclick="exportCSV()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-semibold">üì§ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å CSV</button>
                <button onclick="clearHistory()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-semibold">üóëÔ∏è ‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-4 py-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤</th>
                            <th class="px-4 py-2">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th>
                            <th class="px-4 py-2">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                            <th class="px-4 py-2">‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</th>
                            <th class="px-4 py-2">‡∏Å‡∏≥‡πÑ‡∏£</th>
                            <th class="px-4 py-2">‡∏ä‡∏≥‡∏£‡∏∞</th>
                            <th class="px-4 py-2">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                        </tr>
                    </thead>
                    <tbody id="history-body"></tbody>
                </table>
            </div>
        </div>
    </div>
    <div id="finance-page" class="page p-6 hidden">
        <div id="finance-login" class="max-w-md mx-auto bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-semibold mb-4 text-center">üí∞ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô</h2>
            <input type="password" id="finance-password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" class="w-full p-3 border border-gray-300 rounded-lg mb-4">
            <button onclick="checkFinancePassword()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-semibold">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
        <div id="finance-main" class="hidden">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4">üí∞ ‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô</h2>

                <div class="bg-gray-100 p-4 rounded-lg mb-6 border border-gray-200">
                    <h3 class="text-lg font-semibold mb-2">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">‡∏¢‡∏≠‡∏î‡∏¢‡∏Å‡∏°‡∏≤ (‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î)</label>
                            <input type="number" id="initial-cash-balance" placeholder="0.00" class="mt-1 w-full p-2 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">‡∏¢‡∏≠‡∏î‡∏¢‡∏Å‡∏°‡∏≤ (‡πÉ‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ/‡πÇ‡∏≠‡∏ô)</label>
                            <input type="number" id="initial-bank-balance" placeholder="0.00" class="mt-1 w-full p-2 border border-gray-300 rounded-lg">
                        </div>
                        <button onclick="saveInitialBalances()" class="bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg font-semibold">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≠‡∏î‡∏¢‡∏Å‡∏°‡∏≤</button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div class="bg-purple-50 p-4 rounded-lg border-l-4 border-purple-500">
                         <h3 class="text-lg font-semibold text-purple-800">‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</h3>
                         <div class="mt-2 space-y-2">
                             <div class="flex justify-between text-sm"><span>‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏ß‡∏°:</span> <span id="totalIncome" class="font-semibold text-green-600">0.00</span></div>
                             <div class="flex justify-between text-sm"><span>‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏°:</span> <span id="totalExpense" class="font-semibold text-red-600">0.00</span></div>
                             <hr class="my-1">
                             <div class="flex justify-between"><span>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î:</span> <span id="cash-balance" class="font-bold">0.00</span></div>
                             <div class="flex justify-between"><span>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÉ‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ:</span> <span id="bank-balance" class="font-bold">0.00</span></div>
                             <div class="flex justify-between text-lg text-blue-600 mt-1"><strong>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</strong> <strong id="total-balance">0.00</strong></div>
                         </div>
                    </div>
                    <div class="bg-indigo-50 p-4 rounded-lg border-l-4 border-indigo-500">
                         <h3 class="text-lg font-semibold text-indigo-800">‡∏™‡∏£‡∏∏‡∏õ‡∏ï‡∏≤‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h3>
                         <div class="flex space-x-2 mt-2">
                            <select id="finance-month-filter" class="p-2 border border-gray-300 rounded-lg text-sm flex-1">
                                <option value="1">‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°</option>
                                <option value="2">‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå</option>
                                <option value="3">‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°</option>
                                <option value="4">‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô</option>
                                <option value="5">‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°</option>
                                <option value="6">‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô</option>
                                <option value="7">‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°</option>
                                <option value="8">‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°</option>
                                <option value="9">‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô</option>
                                <option value="10">‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°</option>
                                <option value="11">‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô</option>
                                <option value="12">‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°</option>
                            </select>
                            <select id="finance-year-filter" class="p-2 border border-gray-300 rounded-lg text-sm w-32"></select>
                        </div>
                         <div class="grid grid-cols-1 sm:grid-cols-3 gap-2 mt-3 text-center">
                            <div class="bg-green-100 p-2 rounded">
                                <h4 class="text-xs text-green-800">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</h4>
                                <p class="text-lg font-bold text-green-600" id="monthlyIncome">0.00</p>
                            </div>
                            <div class="bg-red-100 p-2 rounded">
                                <h4 class="text-xs text-red-800">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</h4>
                                <p class="text-lg font-bold text-red-600" id="monthlyExpense">0.00</p>
                            </div>
                            <div class="bg-blue-100 p-2 rounded">
                                <h4 class="text-xs text-blue-800">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</h4>
                                <p class="text-lg font-bold text-blue-600" id="monthlyBalance">0.00</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-4">
                    <select id="finance-type" class="p-2 border border-gray-300 rounded-lg">
                        <option value="‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</option>
                        <option value="‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</option>
                    </select>
                    <select id="finance-payment-method" class="p-2 border border-gray-300 rounded-lg">
                        <option value="‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î">‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</option>
                        <option value="‡πÇ‡∏≠‡∏ô">‡πÇ‡∏≠‡∏ô</option>
                    </select>
                    <input type="number" id="finance-amount" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô" class="p-2 border border-gray-300 rounded-lg">
                    <input type="text" id="finance-description" placeholder="‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢" class="p-2 border border-gray-300 rounded-lg">
                    <input type="date" id="finance-date" class="p-2 border border-gray-300 rounded-lg">
                    <button onclick="addFinanceTransaction()" class="col-span-full bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg font-semibold">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
                </div>

                <div class="mt-4 flex justify-between items-center">
                    <button onclick="openDateRangeModal('finance')" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-semibold">üìÖ ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
                </div>
                <br>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-2 text-left">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                <th class="px-4 py-2 text-left">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                                <th class="px-4 py-2 text-left">‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á</th>
                                <th class="px-4 py-2 text-left">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢</th>
                                <th class="px-4 py-2 text-right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th>
                                <th class="px-4 py-2 text-center">‡∏•‡∏ö</th>
                            </tr>
                        </thead>
                        <tbody id="transactionList"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <div id="settings-page" class="page p-6 hidden">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4">üíæ ‡∏™‡∏≥‡∏£‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h2>
                <p class="text-gray-600 mb-4">‡πÉ‡∏ä‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏π‡∏ç‡∏´‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
                <div class="space-y-3">
                    <button onclick="exportData()" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg font-semibold">üì• ‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Export)</button>
                    <button onclick="importData()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-semibold">üì§ ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Import)</button>
                </div>
            </div>
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-semibold mb-4">‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</h2>
                <div class="space-y-6">
                    <div>
                        <h3 class="text-lg font-medium mb-2">üè™ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
                        <div class="grid grid-cols-1 gap-4">
                            <input type="text" id="shop-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏£‡πâ‡∏≤‡∏ô" class="p-2 border border-gray-300 rounded-lg">
                            <input type="text" id="shop-address" placeholder="‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà" class="p-2 border border-gray-300 rounded-lg">
                            <input type="text" id="shop-phone" placeholder="‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£" class="p-2 border border-gray-300 rounded-lg">
                            <input type="text" id="shop-tax" placeholder="‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ" class="p-2 border border-gray-300 rounded-lg">
                        </div>
                    </div>
                     <div>
                        <h3 class="text-lg font-medium mb-2">üí∞ ‡∏†‡∏≤‡∏©‡∏µ‡∏°‡∏π‡∏•‡∏Ñ‡πà‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏° (VAT)</h3>
                        <div class="grid grid-cols-1 gap-4">
                            <input type="number" id="vat-rate" placeholder="‡∏≠‡∏±‡∏ï‡∏£‡∏≤ VAT (‡πÄ‡∏ä‡πà‡∏ô 7)" class="p-2 border border-gray-300 rounded-lg">
                            <p class="text-sm text-gray-600">‡∏£‡∏∞‡∏ö‡∏∏‡∏≠‡∏±‡∏ï‡∏£‡∏≤ VAT ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå (%)</p>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-lg font-medium mb-2">üîî ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å</h3>
                        <div class="grid grid-cols-1 gap-4">
                            <input type="number" id="low-stock-threshold" placeholder="‡∏Ç‡∏µ‡∏î‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ï‡πà‡∏≥ (‡πÄ‡∏ä‡πà‡∏ô 5)" class="p-2 border border-gray-300 rounded-lg">
                            <p class="text-sm text-gray-600">‡∏£‡∏∞‡∏ö‡∏∏‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ï‡πà‡∏≥‡∏Å‡∏ß‡πà‡∏≤‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤ "‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ï‡πà‡∏≥"</p>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-lg font-medium mb-2">üîí ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</h3>
                        <div class="grid grid-cols-1 gap-4">
                            <input type="password" id="current-password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô" class="p-2 border border-gray-300 rounded-lg">
                            <input type="password" id="new-password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà" class="p-2 border border-gray-300 rounded-lg">
                            <button onclick="changePassword()" class="bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg font-semibold">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</button>
                        </div>
                    </div>
                </div>
                <button onclick="saveSettings()" class="mt-4 w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-lg font-semibold">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
            </div>
        </div>
    </div>
    <div id="add-product-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
            <h3 class="text-xl font-semibold mb-4">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏´‡∏°‡πà</h3>
            <div class="grid grid-cols-1 gap-4 mb-4">
                <input type="text" id="new-product-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤" class="p-2 border border-gray-300 rounded-lg">
                <input type="text" id="new-product-code" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤" class="p-2 border border-gray-300 rounded-lg">
                <input type="text" id="new-product-category" placeholder="‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà (‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°)" class="p-2 border border-gray-300 rounded-lg">
                <input type="number" id="new-product-price" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢" class="p-2 border border-gray-300 rounded-lg">
                <input type="number" id="new-product-cost" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏∏‡∏ô" class="p-2 border border-gray-300 rounded-lg">
                <input type="number" id="new-product-stock" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å" class="p-2 border border-gray-300 rounded-lg">
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-1">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£):</label>
                    <input type="file" id="new-product-image" accept="image/*" class="w-full p-2 border border-gray-300 rounded-lg">
                    <div id="new-image-preview" class="w-20 h-20 mx-auto bg-gray-100 rounded-full flex items-center justify-center text-3xl mt-2">üì∏</div>
                </div>
            </div>
            <div class="flex space-x-2 justify-center">
                <button onclick="closeAddModal()" class="modal-button bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button onclick="addNewProduct()" class="modal-button bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-semibold">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
            </div>
        </div>
    </div>
    <div id="edit-product-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full p-6">
            <h3 class="text-xl font-semibold mb-4">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
            <div class="grid grid-cols-1 gap-4 mb-4">
                <input type="text" id="edit-product-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤" class="p-2 border border-gray-300 rounded-lg">
                <input type="text" id="edit-product-code" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤" class="p-2 border border-gray-300 rounded-lg">
                 <input type="text" id="edit-product-category" placeholder="‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà" class="p-2 border border-gray-300 rounded-lg">
                <input type="number" id="edit-product-price" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢" class="p-2 border border-gray-300 rounded-lg">
                <input type="number" id="edit-product-cost" placeholder="‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏∏‡∏ô" class="p-2 border border-gray-300 rounded-lg">
                <input type="number" id="edit-product-stock" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏ï‡πá‡∏≠‡∏Å" class="p-2 border border-gray-300 rounded-lg">
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-1">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô:</label>
                    <div id="current-image-preview" class="w-20 h-20 mx-auto bg-gray-100 rounded-full flex items-center justify-center text-3xl mb-2">üì∏</div>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-1">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£):</label>
                    <input type="file" id="edit-product-image" accept="image/*" class="w-full p-2 border border-gray-300 rounded-lg">
                    <div id="edit-image-preview" class="w-20 h-20 mx-auto bg-gray-100 rounded-full flex items-center justify-center text-3xl mt-2">üì∏</div>
                </div>
            </div>
            <div class="flex space-x-2 justify-center">
                <button onclick="closeEditModal()" class="modal-button bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button onclick="saveEditProduct()" class="modal-button bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-semibold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
            </div>
        </div>
    </div>
    <div id="date-range-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-8 transform transition-all">
            <h3 class="text-2xl font-bold text-center mb-6 text-gray-800 flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
                ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
            </h3>
            <div class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
                    <input type="date" id="start-date" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</label>
                    <input type="date" id="end-date" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition">
                </div>
            </div>
            <div class="flex space-x-3 justify-center mt-8">
                <button onclick="closeDateRangeModal()" class="px-6 py-3 bg-gray-500 hover:bg-gray-600 text-white rounded-lg font-medium transition transform hover:scale-105">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button onclick="confirmDateRange()" class="px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium transition transform hover:scale-105">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
            </div>
        </div>
    </div>

    <div id="held-carts-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl max-w-lg w-full p-6">
            <h3 class="text-xl font-semibold mb-4">‡∏ö‡∏¥‡∏•‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å‡πÑ‡∏ß‡πâ</h3>
            <div id="held-carts-list" class="space-y-2 max-h-96 overflow-y-auto">
                </div>
            <div class="text-center mt-4">
                <button onclick="closeHeldCartsModal()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg">‡∏õ‡∏¥‡∏î</button>
            </div>
        </div>
    </div>


    <script>
        // --- ‡∏£‡∏π‡∏õ Placeholder ---
        const PLACEHOLDER_IMAGE = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYwIiBoZWlnaHQ9IjE2MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTYwIiBoZWlnaHQ9IjE2MCIgZmlsbD0iI2UwZTBlMCIvPjx0ZXh0IHg9IjgwIiB5PSI4MCIgZm9udC1mYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjE4IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkb21pbmFudC1iYXNlbGluZT0ibWlkZGxlIiBmaWxsPSIjYzBjMGMwIj5ObyBJbWFnZTwvdGV4dD48L3N2Zz4=';
        // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ---
        function getImageHtml(image) {
            if (typeof image === 'string' && image.startsWith('data:image')) {
                return `<img src="${image}" class="w-16 h-16 mx-auto rounded-full object-cover shadow-inner" alt="‡∏£‡∏π‡∏õ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤">`;
            }
            return `<div class="w-16 h-16 mx-auto rounded-full bg-gray-200 flex items-center justify-center text-gray-400 text-xs shadow-inner">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ</div>`;
        }
        // --- ‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û ---
        function compressImage(file, maxWidth = 200, maxHeight = 200) {
            return new Promise((resolve) => {
                const img = new Image();
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                img.onload = () => {
                    let { width, height } = img;
                    if (width > height) {
                        if (width > maxWidth) {
                            height *= maxWidth / width;
                            width = maxWidth;
                        }
                    } else {
                        if (height > maxHeight) {
                            width *= maxHeight / height;
                            height = maxHeight;
                        }
                    }
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', 0.7));
                };
                img.src = URL.createObjectURL(file);
            });
        }
        // Global variables
        let products = [];
        let cart = [];
        let salesHistory = [];
        let stockHistory = [];
        let heldCarts = []; // --- NEW FEATURE: Hold Cart ---
        let receiptCounter = parseInt(localStorage.getItem('pos-receipt-counter')) || 1;
        let settings = JSON.parse(localStorage.getItem('pos-settings')) || {
            shopName: '‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô',
            shopAddress: '123 ‡∏ñ‡∏ô‡∏ô‡∏™‡∏∏‡∏Ç‡∏∏‡∏°‡∏ß‡∏¥‡∏ó ‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏Ø',
            shopPhone: '02-123-4567',
            shopTax: '1234567890123',
            password: 'Pass1234',
            lowStockThreshold: 5,
            vatRate: 7
        };
        let currentEditProductId = null;
        let financeTransactions = [];
        let financeBalances = JSON.parse(localStorage.getItem('pos-finance-balances')) || {
            cash: 0,
            bank: 0
        };
        let currentReportType = null;
        let salesChartInstance = null; // --- NEW FEATURE: Dashboard ---

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            const savedCart = localStorage.getItem('pos-cart');
            if (savedCart) {
                cart = JSON.parse(savedCart);
            }
            // --- NEW FEATURE: Hold Cart ---
            const savedHeldCarts = localStorage.getItem('pos-held-carts');
            if (savedHeldCarts) {
                heldCarts = JSON.parse(savedHeldCarts);
            }

            showPage('dashboard'); // --- NEW: Default to dashboard ---
            loadInitialData();
            loadSettings();
            updateCart();
            updateHeldCartCount();

            document.getElementById('product-search').addEventListener('input', searchProducts);
            // --- NEW FEATURE: Barcode Scanner Support ---
            document.getElementById('product-search').addEventListener('keypress', handleBarcodeScan);
            
            document.getElementById('cash-received').addEventListener('input', calculateChange);
            document.getElementById('payment-method').addEventListener('change', togglePaymentMethod);
            document.getElementById('stock-password').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') checkStockPassword();
            });
            document.getElementById('cash-received').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') processPayment();
            });
            document.getElementById('finance-password').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') checkFinancePassword();
            });
            document.getElementById('stock-history-password').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') checkStockHistoryPassword();
            });

            document.getElementById('discount-value').addEventListener('input', updateCart);
            document.getElementById('discount-type').addEventListener('change', updateCart);
            document.getElementById('vat-toggle').addEventListener('change', updateCart);

            document.getElementById('new-product-image').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById('new-image-preview').innerHTML = `<img src="${e.target.result}" class="w-20 h-20 rounded-full object-cover">`;
                    };
                    reader.readAsDataURL(file);
                }
            });
            document.getElementById('edit-product-image').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById('edit-image-preview').innerHTML = `<img src="${e.target.result}" class="w-20 h-20 rounded-full object-cover">`;
                    };
                    reader.readAsDataURL(file);
                }
            });

            const currentYear = new Date().getFullYear();
            const yearDropdowns = [
                document.getElementById('year-filter'),
                document.getElementById('finance-year-filter'),
                document.getElementById('stock-history-year-filter')
            ];

            yearDropdowns.forEach(dropdown => {
                if (!dropdown) return;
                dropdown.innerHTML = ''; // Clear previous options
                for (let y = currentYear - 5; y <= currentYear + 1; y++) {
                    const option = document.createElement('option');
                    option.value = y;
                    option.textContent = y + 543;
                    if (y === currentYear) option.selected = true;
                    dropdown.appendChild(option);
                }
            });

            const currentMonth = new Date().getMonth() + 1;
            document.getElementById('month-filter').value = currentMonth;
            document.getElementById('finance-month-filter').value = currentMonth;
            document.getElementById('stock-history-month-filter').value = currentMonth;

            document.getElementById('month-filter').addEventListener('change', filterByMonth);
            document.getElementById('year-filter').addEventListener('change', filterByMonth);
            document.getElementById('finance-month-filter').addEventListener('change', filterFinanceByMonth);
            document.getElementById('finance-year-filter').addEventListener('change', filterFinanceByMonth);
            document.getElementById('stock-history-month-filter').addEventListener('change', filterStockHistoryByMonth);
            document.getElementById('stock-history-year-filter').addEventListener('change', filterStockHistoryByMonth);

        });

        // Page navigation
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.add('hidden'));
            document.getElementById(pageId + '-page').classList.remove('hidden');
            
            if (pageId === 'dashboard') { // --- NEW FEATURE: Dashboard ---
                updateDashboard();
            }
            if (pageId === 'history') {
                loadHistory();
            }
            if (pageId === 'stock') {
                document.getElementById('stock-login').classList.remove('hidden');
                document.getElementById('stock-main').classList.add('hidden');
            }
            if (pageId === 'finance') checkFinancePage();
            if (pageId === 'stock-history') {
                document.getElementById('stock-history-login').classList.remove('hidden');
                document.getElementById('stock-history-main').classList.add('hidden');
            }
            if (pageId === 'sales') {
                checkLowStockAlert();
                loadCategoryFilters();
            }
        }
        function checkFinancePage() {
            const login = document.getElementById('finance-login');
            const main = document.getElementById('finance-main');
            const saved = localStorage.getItem('pos-finance');
            if (saved) {
                financeTransactions = JSON.parse(saved);
            } else {
                financeTransactions = [];
            }
            login.classList.remove('hidden');
            main.classList.add('hidden');
            document.getElementById('finance-password').value = '';
        }

        function loadInitialBalances() {
            const savedBalances = JSON.parse(localStorage.getItem('pos-finance-balances'));
            if (savedBalances) {
                financeBalances = savedBalances;
            }
            document.getElementById('initial-cash-balance').value = financeBalances.cash;
            document.getElementById('initial-bank-balance').value = financeBalances.bank;
        }

        function saveInitialBalances() {
            const cash = parseFloat(document.getElementById('initial-cash-balance').value) || 0;
            const bank = parseFloat(document.getElementById('initial-bank-balance').value) || 0;

            financeBalances = { cash, bank };
            localStorage.setItem('pos-finance-balances', JSON.stringify(financeBalances));

            calculateFinanceSummary();
            showSuccessModal('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏¢‡∏≠‡∏î‡∏¢‡∏Å‡∏°‡∏≤‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß');
        }


        function checkFinancePassword() {
            const p = document.getElementById('finance-password').value;
            if (!p) {
                showErrorModal('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô', '‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö');
                return;
            }
            showLoadingModal('‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...');
            setTimeout(() => {
                if (p === settings.password) {
                    document.getElementById('finance-login').classList.add('hidden');
                    document.getElementById('finance-main').classList.remove('hidden');
                    loadInitialBalances();
                    calculateFinanceSummary();
                    filterFinanceByMonth();
                    showSuccessModal('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö');
                } else {
                    showErrorModal('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', '‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
                    document.getElementById('finance-password').value = '';
                }
            }, 1000);
        }
        function renderFinanceTransactions(transactions) {
            const list = document.getElementById('transactionList');
            list.innerHTML = '';
            if (transactions.length === 0) {
                list.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</td></tr>`;
                return;
            }
            transactions.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach((t) => {
                const tr = document.createElement('tr');
                const transactionIndex = financeTransactions.indexOf(t);
                tr.innerHTML = `
                    <td class="px-4 py-2">${formatDate(t.date)}</td>
                    <td class="px-4 py-2 ${t.type === '‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö' ? 'text-green-600' : 'text-red-600'}">${t.type}</td>
                    <td class="px-4 py-2">${t.method || '-'}</td>
                    <td class="px-4 py-2">${t.description || '-'}</td>
                    <td class="px-4 py-2 text-right">‡∏ø${parseFloat(t.amount).toFixed(2)}</td>
                    <td class="px-4 py-2 text-center">
                        <button onclick="deleteFinanceTransaction(${transactionIndex})" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm">
                            ‡∏•‡∏ö
                        </button>
                    </td>
                `;
                list.appendChild(tr);
            });
        }
        function calculateFinanceSummary() {
            let currentCash = financeBalances.cash;
            let currentBank = financeBalances.bank;

            let totalIncome = 0;
            let totalExpense = 0;

            financeTransactions.forEach(t => {
                const amount = parseFloat(t.amount);
                if (t.type === '‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö') {
                    totalIncome += amount;
                    if (t.method === '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î') {
                        currentCash += amount;
                    } else if (t.method === '‡πÇ‡∏≠‡∏ô') {
                        currentBank += amount;
                    }
                } else if (t.type === '‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢') {
                    totalExpense += amount;
                    if (t.method === '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î') {
                        currentCash -= amount;
                    } else if (t.method === '‡πÇ‡∏≠‡∏ô') {
                        currentBank -= amount;
                    }
                }
            });

            document.getElementById('totalIncome').textContent = `‡∏ø${totalIncome.toFixed(2)}`;
            document.getElementById('totalExpense').textContent = `‡∏ø${totalExpense.toFixed(2)}`;
            document.getElementById('cash-balance').textContent = `‡∏ø${currentCash.toFixed(2)}`;
            document.getElementById('bank-balance').textContent = `‡∏ø${currentBank.toFixed(2)}`;
            document.getElementById('total-balance').textContent = `‡∏ø${(currentCash + currentBank).toFixed(2)}`;
        }


        function filterFinanceByMonth() {
            const month = parseInt(document.getElementById('finance-month-filter').value);
            const year = parseInt(document.getElementById('finance-year-filter').value);
            const startDate = new Date(year, month - 1, 1);
            const endDate = new Date(year, month, 0, 23, 59, 59, 999);

            const monthlyTransactions = financeTransactions.filter(t => {
                const d = new Date(t.date);
                return d >= startDate && d <= endDate;
            });

            const monthlyIncome = monthlyTransactions
                .filter(t => t.type === '‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö')
                .reduce((sum, t) => sum + parseFloat(t.amount), 0);
            const monthlyExpense = monthlyTransactions
                .filter(t => t.type === '‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢')
                .reduce((sum, t) => sum + parseFloat(t.amount), 0);
            const monthlyBalance = monthlyIncome - monthlyExpense;

            document.getElementById('monthlyIncome').textContent = monthlyIncome.toFixed(2);
            document.getElementById('monthlyExpense').textContent = monthlyExpense.toFixed(2);
            document.getElementById('monthlyBalance').textContent = monthlyBalance.toFixed(2);

            renderFinanceTransactions(monthlyTransactions);
        }
        function addFinanceTransaction() {
            const type = document.getElementById('finance-type').value;
            const method = document.getElementById('finance-payment-method').value;
            const amount = parseFloat(document.getElementById('finance-amount').value);
            const description = document.getElementById('finance-description').value.trim();
            const date = document.getElementById('finance-date').value;

            if (!amount || amount <= 0) {
                showErrorModal('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                return;
            }
            if (!date) {
                showErrorModal('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà');
                return;
            }
            const transaction = { type, amount, description, date, method };
            financeTransactions.unshift(transaction);
            localStorage.setItem('pos-finance', JSON.stringify(financeTransactions));

            calculateFinanceSummary();
            filterFinanceByMonth();

            document.getElementById('finance-amount').value = '';
            document.getElementById('finance-description').value = '';
            showSuccessModal('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', `‡πÄ‡∏û‡∏¥‡πà‡∏° "${type} (${method}) ‡∏ø${amount.toFixed(2)}" ‡πÅ‡∏•‡πâ‡∏ß`);
        }

        function deleteFinanceTransaction(index) {
            const t = financeTransactions[index];
            showWarningModal('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö', `‡∏•‡∏ö "${t.type} ‡∏ø${t.amount}" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`, () => {
                financeTransactions.splice(index, 1);
                localStorage.setItem('pos-finance', JSON.stringify(financeTransactions));
                calculateFinanceSummary();
                filterFinanceByMonth();
                showSuccessModal('‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß');
            }, true);
        }
        function formatDate(dateStr) {
             if (!dateStr) return '-';
            const d = new Date(dateStr);
            const day = String(d.getDate()).padStart(2, '0');
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const year = d.getFullYear() + 543;
            return `${day}/${month}/${year}`;
        }
        function loadInitialData() {
            try {
                const localProducts = JSON.parse(localStorage.getItem('pos-products'));
                const localHistory = JSON.parse(localStorage.getItem('pos-history'));
                const localStockHistory = JSON.parse(localStorage.getItem('pos-stock-history')) || [];
                if (localProducts && localProducts.length > 0) {
                    products = localProducts.map(p => ({
                        ...p, 
                        cost: p.cost || 0,
                        showOnSales: p.showOnSales !== undefined ? p.showOnSales : true,
                        category: p.category || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà' // --- NEW FEATURE: Categories ---
                    }));
                } else {
                    products = [
                        {id: 1, name: '‡∏ô‡πâ‡∏≥‡∏î‡∏∑‡πà‡∏°', code: 'W001', price: 10, cost: 5, stock: 50, image: null, showOnSales: true, category: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°'},
                        {id: 2, name: '‡∏Ç‡∏ô‡∏°‡∏õ‡∏±‡∏á', code: 'B001', price: 25, cost: 15, stock: 30, image: null, showOnSales: true, category: '‡πÄ‡∏ö‡πÄ‡∏Å‡∏≠‡∏£‡∏µ‡πà'},
                        {id: 3, name: '‡∏Å‡∏≤‡πÅ‡∏ü', code: 'C001', price: 35, cost: 20, stock: 20, image: null, showOnSales: true, category: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°'},
                        {id: 4, name: '‡∏•‡∏π‡∏Å‡∏≠‡∏°', code: 'S001', price: 5, cost: 2, stock: 100, image: null, showOnSales: true, category: '‡∏Ç‡∏ô‡∏°'},
                        {id: 5, name: '‡∏Ç‡∏ô‡∏°‡∏Ç‡∏ö‡πÄ‡∏Ñ‡∏µ‡πâ‡∏¢‡∏ß', code: 'S002', price: 20, cost: 12, stock: 75, image: null, showOnSales: true, category: '‡∏Ç‡∏ô‡∏°'},
                        {id: 6, name: '‡∏ô‡πâ‡∏≥‡∏≠‡∏±‡∏î‡∏•‡∏°', code: 'D001', price: 20, cost: 11, stock: 40, image: null, showOnSales: true, category: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°'}
                    ];
                    localStorage.setItem('pos-products', JSON.stringify(products));
                }
                 if (localHistory) {
                    salesHistory = localHistory;
                } else {
                    salesHistory = [];
                }
                stockHistory = localStockHistory;
                loadProducts();
            } catch (e) {
                showErrorModal('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Local Storage ‡πÑ‡∏î‡πâ ‡∏≠‡∏≤‡∏à‡πÄ‡∏Å‡∏¥‡∏î‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢');
                console.error(e);
            }
        }
        function refreshProducts() {
            document.getElementById('loading-products').classList.remove('hidden');
            document.getElementById('product-grid').classList.add('hidden');
            setTimeout(() => {
                loadProducts();
                document.getElementById('loading-products').classList.add('hidden');
                document.getElementById('product-grid').classList.remove('hidden');
            }, 500);
        }

        // --- NEW FEATURE: Refactored Product Card Rendering ---
        function createProductCardHTML(product) {
            let stockBadge = '', stockColor = '';
            if (product.stock === 0) { stockBadge = '‡∏´‡∏°‡∏î'; stockColor = 'bg-red-100 text-red-800 border-red-200'; }
            else if (product.stock <= settings.lowStockThreshold) { stockBadge = '‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ï‡πà‡∏≥'; stockColor = 'bg-yellow-100 text-yellow-800 border-yellow-200'; }
            else { stockBadge = '‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡∏≤‡∏¢'; stockColor = 'bg-green-100 text-green-800 border-green-200'; }
            
            return `
                <div class="relative">
                    <div class="absolute -top-2 -right-2 px-2 py-1 rounded-full text-xs font-semibold border ${stockColor}">${stockBadge}</div>
                    <div class="text-center mb-3">
                        ${getImageHtml(product.image)}
                    </div>
                    <div class="text-center space-y-2">
                        <h3 class="font-semibold text-gray-800 text-sm leading-tight min-h-[2.5rem] flex items-center justify-center">${product.name}</h3>
                        <div class="bg-gray-100 rounded-md px-2 py-1"><p class="text-xs text-gray-600 font-mono">${product.code}</p></div>
                        <div class="bg-blue-50 rounded-lg py-2"><p class="text-xl font-bold text-blue-600">‡∏ø${product.price.toLocaleString()}</p></div>
                        <div class="flex justify-between items-center text-xs">
                            <span class="text-gray-500">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠:</span>
                            <span class="font-semibold ${product.stock > settings.lowStockThreshold ? 'text-green-600' : product.stock > 0 ? 'text-yellow-600' : 'text-red-600'}">${product.stock} ‡∏ä‡∏¥‡πâ‡∏ô</span>
                        </div>
                        ${product.stock > 0 ? `
                            <button class="w-full mt-2 bg-blue-600 hover:bg-blue-700 text-white py-2 px-3 rounded-lg text-xs font-semibold transition-colors duration-200 flex items-center justify-center space-x-1">
                                <span>üõí</span><span>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</span>
                            </button>` : `
                            <button class="w-full mt-2 bg-gray-400 text-white py-2 px-3 rounded-lg text-xs font-semibold cursor-not-allowed">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏°‡∏î</button>`}
                    </div>
                </div>`;
        }
        
        // --- NEW FEATURE: Render Product Grid ---
        function renderProductGrid(productsToRender) {
             const grid = document.getElementById('product-grid');
            grid.innerHTML = '';
            if (productsToRender.length === 0) {
                grid.innerHTML = '<div class="col-span-full text-center text-gray-500 py-8">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div>';
                return;
            }
            productsToRender.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = `bg-white p-4 rounded-xl border-2 hover:border-blue-300 hover:shadow-lg transition-all duration-300 cursor-pointer transform hover:scale-105 ${product.stock === 0 ? 'opacity-50 cursor-not-allowed' : ''}`;
                if (product.stock > 0) {
                    productCard.onclick = () => addToCartWithQuantity(product);
                }
                productCard.innerHTML = createProductCardHTML(product);
                grid.appendChild(productCard);
            });
        }

        function loadProducts(filterCategory = 'All') { // --- NEW: Added category filter ---
            const productsToShow = products.filter(p => p.showOnSales);
            let filtered = productsToShow;
            if (filterCategory !== 'All') {
                filtered = productsToShow.filter(p => p.category === filterCategory);
            }
            renderProductGrid(filtered);
        }

        function searchProducts() {
            const term = document.getElementById('product-search').value.toLowerCase();
            const filtered = products.filter(p =>
                p.showOnSales &&
                (p.name.toLowerCase().includes(term) || p.code.toLowerCase().includes(term))
            );
            renderProductGrid(filtered);
        }
        
        // --- NEW FEATURE: Barcode Scanner Support ---
        function handleBarcodeScan(e) {
            if (e.key === 'Enter') {
                const code = document.getElementById('product-search').value.trim();
                if (!code) return;

                const product = products.find(p => p.code === code);
                if (product) {
                    if (product.stock > 0) {
                        const existing = cart.find(c => c.id === product.id);
                        if (existing) {
                            changeQuantity(product.id, 1);
                        } else {
                             cart.push({ id: product.id, name: product.name, price: product.price, cost: product.cost, quantity: 1 });
                             updateCart();
                        }
                        showSuccessModal('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', `‡πÄ‡∏û‡∏¥‡πà‡∏° ${product.name} 1 ‡∏ä‡∏¥‡πâ‡∏ô`);
                    } else {
                        showErrorModal('‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏°‡∏î', `‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ${product.name} ‡∏´‡∏°‡∏î‡∏™‡∏ï‡πá‡∏≠‡∏Å`);
                    }
                } else {
                    showErrorModal('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', `‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏£‡∏´‡∏±‡∏™: ${code}`);
                }
                // Clear search bar after scan
                document.getElementById('product-search').value = '';
                e.preventDefault(); // Prevent form submission if it's inside one
            }
        }
        
        // --- NEW FEATURE: Categories ---
        function loadCategoryFilters() {
            const container = document.getElementById('category-filters');
            const categories = ['All', ...new Set(products.map(p => p.category || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà'))];
            container.innerHTML = categories.map(cat => 
                `<button 
                    onclick="filterByCategory('${cat}', this)" 
                    class="category-btn px-3 py-1 text-sm rounded-full border-2 ${cat === 'All' ? 'bg-blue-600 text-white border-blue-600' : 'bg-gray-100 text-gray-700 border-gray-300 hover:bg-blue-100'}"
                >
                    ${cat}
                </button>`
            ).join('');
        }

        function filterByCategory(category, element) {
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('bg-blue-600', 'text-white', 'border-blue-600');
                btn.classList.add('bg-gray-100', 'text-gray-700', 'border-gray-300');
            });
            element.classList.add('bg-blue-600', 'text-white', 'border-blue-600');
            element.classList.remove('bg-gray-100', 'text-gray-700', 'border-gray-300');
            loadProducts(category);
        }

        function checkLowStockAlert() {
            const alert = document.getElementById('low-stock-alert');
            const list = document.getElementById('low-stock-list');
            const lowStockItems = products.filter(p => p.stock > 0 && p.stock <= settings.lowStockThreshold);
            if (lowStockItems.length > 0) {
                alert.classList.remove('hidden');
                list.innerHTML = lowStockItems.map(p => `${p.name} (${p.code}): ${p.stock} ‡∏ä‡∏¥‡πâ‡∏ô`).join(', ');
            } else {
                alert.classList.add('hidden');
            }
        }
        function addToCartWithQuantity(product) {
            if (product.stock === 0) return;
            const input = prompt(`‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢
"${product.name}"
‡∏£‡∏≤‡∏Ñ‡∏≤: ‡∏ø${product.price}
‡∏™‡∏ï‡πá‡∏≠‡∏Å: ${product.stock} ‡∏ä‡∏¥‡πâ‡∏ô`, '1');
            if (!input) return;
            const qty = parseInt(input);
            if (isNaN(qty) || qty <= 0) {
                showErrorModal('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0');
                return;
            }
            if (qty > product.stock) {
                showErrorModal('‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠', `‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏°‡∏µ‡πÄ‡∏û‡∏µ‡∏¢‡∏á ${product.stock} ‡∏ä‡∏¥‡πâ‡∏ô`);
                return;
            }
            const existing = cart.find(c => c.id === product.id);
            if (existing) {
                existing.quantity += qty;
            } else {
                cart.push({ id: product.id, name: product.name, price: product.price, cost: product.cost, quantity: qty });
            }
            updateCart();
        }

        function updateCart() {
            const container = document.getElementById('cart-items');
            container.innerHTML = '';

            let subtotal = 0;
            if (cart.length === 0) {
                container.innerHTML = `<p class="text-center text-gray-400 py-4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</p>`;
            } else {
                cart.forEach(item => {
                    const itemTotal = item.price * item.quantity;
                    subtotal += itemTotal;
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center bg-gray-50 p-2 rounded';
                    div.innerHTML = `
                        <div class="flex-1">
                            <p class="font-medium">${item.name}</p>
                            <p class="text-sm text-gray-600">${item.quantity} √ó ‡∏ø${item.price.toFixed(2)} = ‡∏ø${itemTotal.toFixed(2)}</p>
                        </div>
                        <button onclick="changeQuantity(${item.id}, -1)" class="bg-red-500 text-white px-2 py-1 rounded text-sm">‚àí</button>
                        <span class="mx-2 w-8 text-center">${item.quantity}</span>
                        <button onclick="changeQuantity(${item.id}, 1)" class="bg-green-500 text-white px-2 py-1 rounded text-sm">+</button>
                    `;
                    container.appendChild(div);
                });
            }


            const discountValue = parseFloat(document.getElementById('discount-value').value) || 0;
            const discountType = document.getElementById('discount-type').value;
            let discountAmount = 0;
            if (discountType === 'percent') {
                discountAmount = (subtotal * discountValue) / 100;
            } else {
                discountAmount = discountValue;
            }
            if (discountAmount > subtotal) {
                discountAmount = subtotal;
            }

            const afterDiscount = subtotal - discountAmount;

            const isVatApplied = document.getElementById('vat-toggle').checked;
            let vatAmount = 0;
            if (isVatApplied) {
                vatAmount = afterDiscount * (settings.vatRate / 100);
            }

            const total = afterDiscount + vatAmount;

            document.getElementById('summary-subtotal').textContent = `‡∏ø${subtotal.toFixed(2)}`;
            document.getElementById('summary-discount').textContent = `- ‡∏ø${discountAmount.toFixed(2)}`;
            document.getElementById('summary-after-discount').textContent = `‡∏ø${afterDiscount.toFixed(2)}`;
            document.getElementById('summary-vat').textContent = `‡∏ø${vatAmount.toFixed(2)}`;
            document.getElementById('total-amount').textContent = `‡∏ø${total.toFixed(2)}`;

            calculateChange();
            localStorage.setItem('pos-cart', JSON.stringify(cart));
        }

        function clearCart() {
            if (cart.length === 0) return;
            showWarningModal('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô', '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?', () => {
                cart = [];
                updateCart();
            }, true);
        }

        // --- NEW FEATURE: Hold Cart ---
        function holdCart() {
            if (cart.length === 0) {
                showErrorModal('‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á', '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÉ‡∏´‡πâ‡∏û‡∏±‡∏Å‡∏ö‡∏¥‡∏•');
                return;
            }
            const heldCartItem = {
                items: JSON.parse(JSON.stringify(cart)), // Deep copy
                time: new Date().toISOString()
            };
            heldCarts.push(heldCartItem);
            localStorage.setItem('pos-held-carts', JSON.stringify(heldCarts));
            cart = [];
            updateCart();
            updateHeldCartCount();
            showSuccessModal('‡∏û‡∏±‡∏Å‡∏ö‡∏¥‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏ö‡∏¥‡∏•‡∏ñ‡∏π‡∏Å‡∏û‡∏±‡∏Å‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏° "‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ö‡∏¥‡∏•"');
        }

        function showHeldCarts() {
            const modal = document.getElementById('held-carts-modal');
            const list = document.getElementById('held-carts-list');
            list.innerHTML = '';
            if (heldCarts.length === 0) {
                list.innerHTML = '<p class="text-center text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏¥‡∏•‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å‡πÑ‡∏ß‡πâ</p>';
            } else {
                heldCarts.forEach((held, index) => {
                    const totalItems = held.items.reduce((sum, item) => sum + item.quantity, 0);
                    const totalAmount = held.items.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                    const time = new Date(held.time).toLocaleTimeString('th-TH');
                    const div = document.createElement('div');
                    div.className = 'flex justify-between items-center bg-gray-100 p-3 rounded-lg';
                    div.innerHTML = `
                        <div>
                            <p class="font-semibold">‡∏ö‡∏¥‡∏•‡∏û‡∏±‡∏Å‡πÑ‡∏ß‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠ ${time}</p>
                            <p class="text-sm text-gray-600">${totalItems} ‡∏ä‡∏¥‡πâ‡∏ô / ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° ‡∏ø${totalAmount.toFixed(2)}</p>
                        </div>
                        <div class="flex space-x-2">
                             <button onclick="retrieveCart(${index})" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded">‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏∑‡∏ô</button>
                             <button onclick="deleteHeldCart(${index})" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded">‡∏•‡∏ö</button>
                        </div>
                    `;
                    list.appendChild(div);
                });
            }
            modal.classList.remove('hidden');
        }

        function closeHeldCartsModal() {
             document.getElementById('held-carts-modal').classList.add('hidden');
        }

        function retrieveCart(index) {
            if (cart.length > 0) {
                showWarningModal('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏∑‡∏ô‡∏ö‡∏¥‡∏•', '‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà ‡∏´‡∏≤‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏∑‡∏ô‡∏ö‡∏¥‡∏• ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?', () => {
                    performRetrieve(index);
                }, true);
            } else {
                performRetrieve(index);
            }
        }
        
        function performRetrieve(index) {
            cart = heldCarts[index].items;
            heldCarts.splice(index, 1);
            localStorage.setItem('pos-held-carts', JSON.stringify(heldCarts));
            updateCart();
            updateHeldCartCount();
            closeHeldCartsModal();
            showSuccessModal('‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏∑‡∏ô‡∏ö‡∏¥‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏≤‡∏Å‡∏ö‡∏¥‡∏•‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å‡πÑ‡∏ß‡πâ‡∏ñ‡∏π‡∏Å‡∏ô‡∏≥‡∏°‡∏≤‡πÉ‡∏™‡πà‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß');
        }

        function deleteHeldCart(index) {
            showWarningModal('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö', '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ö‡∏¥‡∏•‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å‡πÑ‡∏ß‡πâ‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?', () => {
                heldCarts.splice(index, 1);
                localStorage.setItem('pos-held-carts', JSON.stringify(heldCarts));
                updateHeldCartCount();
                showHeldCarts(); // Refresh the modal list
            }, true);
        }

        function updateHeldCartCount() {
            const countEl = document.getElementById('held-cart-count');
            countEl.textContent = heldCarts.length;
            countEl.style.display = heldCarts.length > 0 ? 'flex' : 'none';
        }
        // --- END: Hold Cart ---

        function setReceivedCash(amount) {
            const cashInput = document.getElementById('cash-received');
            if (amount === 'exact') {
                const total = parseFloat(document.getElementById('total-amount').textContent.replace('‡∏ø', ''));
                cashInput.value = total.toFixed(2);
            } else {
                cashInput.value = amount;
            }
            calculateChange();
        }

        function changeQuantity(id, delta) {
            const item = cart.find(c => c.id === id);
            if (!item) return;
            const product = products.find(p => p.id === id);
            if (delta > 0 && item.quantity + delta > product.stock) {
                 showErrorModal('‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠', `‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏°‡∏µ‡πÄ‡∏û‡∏µ‡∏¢‡∏á ${product.stock} ‡∏ä‡∏¥‡πâ‡∏ô`);
                return;
            }
            item.quantity += delta;
            if (item.quantity <= 0) {
                cart = cart.filter(c => c.id !== id);
            }
            updateCart();
        }
        function calculateChange() {
            const t = parseFloat(document.getElementById('total-amount').textContent.replace('‡∏ø', ''));
            const r = parseFloat(document.getElementById('cash-received').value) || 0;
            document.getElementById('change-amount').textContent = `‡∏ø${Math.max(0, r - t).toFixed(2)}`;
        }
        function togglePaymentMethod() {
            const method = document.getElementById('payment-method').value;
            document.getElementById('cash-payment').style.display = method === 'cash' ? 'block' : 'none';
            calculateChange();
        }
        function processPayment() {
            if (cart.length === 0) {
                showErrorModal('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏î‡πâ', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô');
                return;
            }
            const subtotal = parseFloat(document.getElementById('summary-subtotal').textContent.replace('‡∏ø', ''));
            const discount = parseFloat(document.getElementById('summary-discount').textContent.replace('- ‡∏ø', ''));
            const afterDiscount = parseFloat(document.getElementById('summary-after-discount').textContent.replace('‡∏ø', ''));
            const vat = parseFloat(document.getElementById('summary-vat').textContent.replace('‡∏ø', ''));
            const total = parseFloat(document.getElementById('total-amount').textContent.replace('‡∏ø', ''));

            const m = document.getElementById('payment-method').value;
            const r = parseFloat(document.getElementById('cash-received').value) || 0;

            if (m === 'cash' && r < total) {
                showErrorModal('‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠', `‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: ‡∏ø${total.toFixed(2)}<br>‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö: ‡∏ø${r.toFixed(2)}<br>‡∏Ç‡∏≤‡∏î‡∏≠‡∏µ‡∏Å: ‡∏ø${(total - r).toFixed(2)}`);
                return;
            }
            showLoadingModal('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•...');
            setTimeout(() => {
                let totalProfit = 0;
                cart.forEach(c => {
                    const p = products.find(x => x.id === c.id);
                    if (p) {
                        const oldStock = p.stock;
                        p.stock -= c.quantity;
                        recordStockChange(p.id, p.name, p.code, -c.quantity, oldStock, p.stock, '‡∏Ç‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤');
                    }
                    totalProfit += (c.price - (c.cost || 0)) * c.quantity;
                });
                const receipt = {
                    id: `POS${String(receiptCounter).padStart(4, '0')}`,
                    date: new Date().toISOString(),
                    items: [...cart],
                    subtotal: subtotal,
                    discount: discount,
                    vat: vat,
                    total: total,
                    totalProfit: totalProfit,
                    paymentMethod: m,
                    received: m === 'cash' ? r : 0,
                    change: m === 'cash' ? Math.max(0, r - total) : 0,
                    status: 'completed'
                };
                salesHistory.unshift(receipt);
                receiptCounter++;
                localStorage.setItem('pos-history', JSON.stringify(salesHistory));
                localStorage.setItem('pos-receipt-counter', receiptCounter);
                localStorage.setItem('pos-products', JSON.stringify(products));
                cart = [];
                document.getElementById('discount-value').value = 0;
                document.getElementById('vat-toggle').checked = false;
                updateCart();
                document.getElementById('cash-received').value = '';
                closeModal();
                showPaymentSuccessModal('‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', `‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à: ${receipt.id}`, receipt);
                checkLowStockAlert();
                if (document.getElementById('history-page').classList.contains('hidden') === false) {
                    loadHistory();
                }
            }, 1000);
        }
        function recordStockChange(productId, productName, productCode, change, oldStock, newStock, reason) {
            const now = new Date();
            const entry = {
                productId,
                productName,
                productCode,
                change,
                oldStock,
                newStock,
                reason,
                date: now.toISOString().split('T')[0],
                time: now.toTimeString().split(' ')[0].substring(0, 8)
            };
            stockHistory.unshift(entry);
            localStorage.setItem('pos-stock-history', JSON.stringify(stockHistory));
        }
        function showPaymentSuccessModal(title, message, receipt) {
            const modal = document.getElementById('modal-overlay');
            const titleEl = document.getElementById('modal-title');
            const messageEl = document.getElementById('modal-message');
            const buttonsContainer = document.getElementById('modal-buttons');
            const icon = document.getElementById('modal-icon');
            titleEl.textContent = title;
            messageEl.innerHTML = message;
            icon.textContent = '‚úÖ';
            buttonsContainer.innerHTML = '';
            const okButton = document.createElement('button');
            okButton.className = 'bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg';
            okButton.textContent = '‡∏ï‡∏Å‡∏•‡∏á';
            okButton.onclick = () => {
                closeModal();
            };
            const printButton = document.createElement('button');
            printButton.className = 'bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg ml-2';
            printButton.textContent = '‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à';
            printButton.onclick = () => {
                closeModal();
                printReceipt(receipt);
            };
            buttonsContainer.appendChild(okButton);
            buttonsContainer.appendChild(printButton);
            modal.classList.remove('hidden');
            modal.classList.add('show');
        }
        function printReceipt(receipt) {
            const div = document.getElementById('receipt-print');
            const itemsHtml = receipt.items.map(i => {
                return `<tr><td style="text-align:left;">${i.name}</td><td style="text-align:center;">${i.quantity}</td><td style="text-align:right;">‡∏ø${i.price.toFixed(2)}</td><td style="text-align:right;">‡∏ø${(i.price * i.quantity).toFixed(2)}</td></tr>`;
            }).join('');
             const afterDiscount = receipt.subtotal - receipt.discount;
            div.innerHTML = `
                <div style="text-align:center;margin-bottom:10px;">
                    <h2>${settings.shopName}</h2>
                    <p>${settings.shopAddress}</p>
                    <p>‡πÇ‡∏ó‡∏£: ${settings.shopPhone}</p>
                    <p>‡πÄ‡∏•‡∏Ç‡∏†‡∏≤‡∏©‡∏µ: ${settings.shopTax}</p><hr>
                </div>
                <p><strong>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà:</strong> ${receipt.id}</p>
                <p><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</strong> ${new Date(receipt.date).toLocaleString('th-TH')}</p>
                <hr>
                <table style="width:100%; border-collapse: collapse;">
                    <thead><tr><th style="text-align:left;">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th style="text-align:center;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th style="text-align:right;">‡∏£‡∏≤‡∏Ñ‡∏≤</th><th style="text-align:right;">‡∏£‡∏ß‡∏°</th></tr></thead>
                    <tbody>${itemsHtml}</tbody>
                </table><hr>
                 <p style="text-align:right;"><strong>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°:</strong> ‡∏ø${receipt.subtotal.toFixed(2)}</p>
                ${receipt.discount > 0 ? `<p style="text-align:right;"><strong>‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î:</strong> - ‡∏ø${receipt.discount.toFixed(2)}</p>` : ''}
                ${receipt.discount > 0 ? `<p style="text-align:right;"><strong>‡∏¢‡∏≠‡∏î‡∏´‡∏•‡∏±‡∏á‡∏´‡∏±‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î:</strong> ‡∏ø${afterDiscount.toFixed(2)}</p>` : ''}
                ${receipt.vat > 0 ? `<p style="text-align:right;"><strong>VAT (${settings.vatRate}%):</strong> ‡∏ø${receipt.vat.toFixed(2)}</p>` : ''}
                <p style="text-align:right; font-size: 1.1em;"><strong>‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥:</strong> ‡∏ø${receipt.total.toFixed(2)}</p>
                ${receipt.paymentMethod === 'cash' ? `<p style="text-align:right;"><strong>‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô:</strong> ‡∏ø${receipt.received.toFixed(2)}</p><p style="text-align:right;"><strong>‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏≠‡∏ô:</strong> ‡∏ø${receipt.change.toFixed(2)}</p>` : ''}
                <p><strong>‡∏ä‡∏≥‡∏£‡∏∞‡πÇ‡∏î‡∏¢:</strong> ${receipt.paymentMethod === 'cash' ? '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î' : 'QR Code'}</p><hr>
                <p style="text-align:center;margin-top:10px;">‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</p>
            `;
            div.classList.remove('hidden');
            window.print();
            div.classList.add('hidden');
        }
        function printLastReceipt() {
            if (salesHistory.length === 0) {
                showWarningModal('‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à', '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢');
                return;
            }
            printReceipt(salesHistory[0]);
        }
        function checkStockPassword() {
            const p = document.getElementById('stock-password').value;
            if (!p) {
                showErrorModal('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô', '‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö');
                return;
            }
            showLoadingModal('‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...');
            setTimeout(() => {
                if (p === settings.password) {
                    document.getElementById('stock-login').classList.add('hidden');
                    document.getElementById('stock-main').classList.remove('hidden');
                    loadStockList();
                    showSuccessModal('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö');
                } else {
                    showErrorModal('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', '‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
                    document.getElementById('stock-password').value = '';
                }
            }, 1000);
        }
        function loadStockList() {
            const container = document.getElementById('stock-list');
            container.innerHTML = '';
            if (products.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-4">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</p>';
                return;
            }
            products.forEach(p => {
                const div = document.createElement('div');
                div.className = 'flex flex-col md:flex-row justify-between items-center bg-white p-4 border rounded-lg mb-2 shadow';
                div.innerHTML = `
                    <div class="flex items-center space-x-3 mb-2 md:mb-0">
                        ${getImageHtml(p.image)}
                        <div>
                            <p class="font-semibold">${p.name}</p>
                            <p class="text-sm text-gray-600">${p.code}</p>
                            <p class="text-xs bg-gray-100 px-2 py-1 rounded-full inline-block mt-1">${p.category || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà'}</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="text-center">
                            <p class="text-sm text-gray-600">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏∏‡∏ô</p>
                            <p class="font-semibold">‡∏ø${p.cost || 0}</p>
                        </div>
                        <div class="text-center">
                            <p class="text-sm text-gray-600">‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏≤‡∏¢</p>
                            <p class="font-semibold">‡∏ø${p.price}</p>
                        </div>
                        <div class="text-center">
                            <p class="text-sm text-gray-600">‡∏™‡∏ï‡πá‡∏≠‡∏Å</p>
                            <p class="font-semibold ${p.stock > settings.lowStockThreshold ? 'text-green-600' : p.stock > 0 ? 'text-yellow-600' : 'text-red-600'}">${p.stock} ‡∏ä‡∏¥‡πâ‡∏ô</p>
                        </div>
                         <div class="text-center">
                            <p class="text-sm text-gray-600 mb-1">‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢</p>
                            <label class="inline-flex items-center cursor-pointer">
                              <input type="checkbox" onchange="toggleShowOnSales(${p.id})" ${p.showOnSales ? 'checked' : ''} class="sr-only peer">
                              <div class="relative w-11 h-6 bg-gray-200 rounded-full peer peer-focus:ring-4 peer-focus:ring-blue-300 peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                            </label>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="openEditModal(${p.id})" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                            <button onclick="adjustStock(${p.id})" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm">üîÑ ‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å</button>
                            <button onclick="deleteProduct(${p.id})" class="bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm">üóëÔ∏è ‡∏•‡∏ö</button>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }
        function toggleShowOnSales(id) {
            const product = products.find(p => p.id === id);
            if (product) {
                product.showOnSales = !product.showOnSales;
                localStorage.setItem('pos-products', JSON.stringify(products));
                if (!document.getElementById('sales-page').classList.contains('hidden')) {
                    refreshProducts();
                }
            }
        }
        function openAddProductModal() {
            document.getElementById('new-product-name').value = '';
            document.getElementById('new-product-code').value = '';
            document.getElementById('new-product-category').value = ''; // --- NEW: Categories ---
            document.getElementById('new-product-price').value = '';
            document.getElementById('new-product-cost').value = '';
            document.getElementById('new-product-stock').value = '';
            document.getElementById('new-product-image').value = '';
            document.getElementById('new-image-preview').innerHTML = 'üì∏';
            document.getElementById('add-product-modal').classList.remove('hidden');
        }
        function closeAddModal() {
            document.getElementById('add-product-modal').classList.add('hidden');
        }
        async function addNewProduct() {
            const n = document.getElementById('new-product-name').value.trim();
            const c = document.getElementById('new-product-code').value.trim();
            const cat = document.getElementById('new-product-category').value.trim(); // --- NEW: Categories ---
            const pr = parseFloat(document.getElementById('new-product-price').value);
            const co = parseFloat(document.getElementById('new-product-cost').value);
            const s = parseInt(document.getElementById('new-product-stock').value);
            const imageFile = document.getElementById('new-product-image').files[0];
            if (!n || !c || isNaN(pr) || isNaN(s) || isNaN(co)) {
                showErrorModal('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á (‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏∏‡∏ô)');
                return;
            }
            if (pr <= 0 || s < 0 || co < 0) {
                showErrorModal('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', '‡∏£‡∏≤‡∏Ñ‡∏≤‡πÅ‡∏•‡∏∞‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0 ‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏∏‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î‡∏•‡∏ö');
                return;
            }
            if (products.find(p => p.code === c)) {
                showErrorModal('‡∏£‡∏´‡∏±‡∏™‡∏ã‡πâ‡∏≥', `‡∏£‡∏´‡∏±‡∏™ "${c}" ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß`);
                return;
            }
            let image = null;
            if (imageFile) {
                image = await compressImage(imageFile);
            }
            const newProduct = {
                id: Date.now(),
                name: n,
                code: c,
                price: pr,
                cost: co,
                stock: s,
                image: image,
                showOnSales: true,
                category: cat || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà' // --- NEW: Categories ---
            };
            products.push(newProduct);
            localStorage.setItem('pos-products', JSON.stringify(products));
            loadStockList();
            closeAddModal();
            refreshProducts();
            showSuccessModal('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', `‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ "${n}" ‡πÅ‡∏•‡πâ‡∏ß`);
            checkLowStockAlert();
            if (document.getElementById('history-page').classList.contains('hidden') === false) {
                loadHistory();
            }
        }
        function openEditModal(id) {
            currentEditProductId = id;
            const p = products.find(x => x.id === id);
            if (!p) return;
            document.getElementById('edit-product-name').value = p.name;
            document.getElementById('edit-product-code').value = p.code;
            document.getElementById('edit-product-category').value = p.category; // --- NEW: Categories ---
            document.getElementById('edit-product-price').value = p.price;
            document.getElementById('edit-product-cost').value = p.cost;
            document.getElementById('edit-product-stock').value = p.stock;
            document.getElementById('current-image-preview').innerHTML = p.image ? `<img src="${p.image}" class="w-20 h-20 rounded-full object-cover">` : `<img src="${PLACEHOLDER_IMAGE}" class="w-20 h-20 rounded-full object-cover">`;
            document.getElementById('edit-image-preview').innerHTML = 'üì∏';
            document.getElementById('edit-product-image').value = '';
            document.getElementById('edit-product-modal').classList.remove('hidden');
        }
        function closeEditModal() {
            document.getElementById('edit-product-modal').classList.add('hidden');
        }
        async function saveEditProduct() {
            const p = products.find(x => x.id === currentEditProductId);
            if (!p) return;
            const n = document.getElementById('edit-product-name').value.trim();
            const c = document.getElementById('edit-product-code').value.trim();
            const cat = document.getElementById('edit-product-category').value.trim(); // --- NEW: Categories ---
            const pr = parseFloat(document.getElementById('edit-product-price').value);
            const co = parseFloat(document.getElementById('edit-product-cost').value);
            const s = parseInt(document.getElementById('edit-product-stock').value);
            const imageFile = document.getElementById('edit-product-image').files[0];
            if (!n || !c || isNaN(pr) || isNaN(s) || isNaN(co)) {
                showErrorModal('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á (‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏∏‡∏ô)');
                return;
            }
            if (pr <= 0 || s < 0 || co < 0) {
                showErrorModal('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', '‡∏£‡∏≤‡∏Ñ‡∏≤‡πÅ‡∏•‡∏∞‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0 ‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏∏‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏¥‡∏î‡∏•‡∏ö');
                return;
            }
            if (c !== p.code && products.find(x => x.code === c)) {
                showErrorModal('‡∏£‡∏´‡∏±‡∏™‡∏ã‡πâ‡∏≥', `‡∏£‡∏´‡∏±‡∏™ "${c}" ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß`);
                return;
            }
            p.name = n;
            p.code = c;
            p.category = cat || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà'; // --- NEW: Categories ---
            p.price = pr;
            p.cost = co;
            p.stock = s;
            if (imageFile) {
                p.image = await compressImage(imageFile);
            }
            localStorage.setItem('pos-products', JSON.stringify(products));
            loadStockList();
            closeEditModal();
            refreshProducts();
            showSuccessModal('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', `‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ "${n}" ‡πÅ‡∏•‡πâ‡∏ß`);
            checkLowStockAlert();
            if (document.getElementById('history-page').classList.contains('hidden') === false) {
                loadHistory();
            }
        }
        function adjustStock(id) {
            const p = products.find(x => x.id === id);
            if (!p) return;
            const input = prompt(`‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å: ${p.name}
‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: ${p.stock}
‡πÉ‡∏™‡πà +5 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏° 5 ‡∏ä‡∏¥‡πâ‡∏ô
‡πÉ‡∏™‡πà -3 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î 3 ‡∏ä‡∏¥‡πâ‡∏ô`, '0');
            if (!input) return;
            const change = parseInt(input);
            if (isNaN(change)) {
                showErrorModal('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç');
                return;
            }
            const oldStock = p.stock;
            p.stock += change;
            if (p.stock < 0) {
                showErrorModal('‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', `‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏¥‡∏î‡∏•‡∏ö‡πÑ‡∏î‡πâ`);
                p.stock = oldStock;
                return;
            }
            recordStockChange(p.id, p.name, p.code, change, oldStock, p.stock, `‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏ï‡πá‡∏≠‡∏Å: ${input}`);
            localStorage.setItem('pos-products', JSON.stringify(products));
            loadStockList();
            showSuccessModal('‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', `‡∏™‡∏ï‡πá‡∏≠‡∏Å: ${oldStock} ‚Üí ${p.stock}`);
            checkLowStockAlert();
            if (document.getElementById('history-page').classList.contains('hidden') === false) {
                loadHistory();
            }
        }
        function deleteProduct(id) {
            const p = products.find(x => x.id === id);
            if (!p) return;
            showWarningModal('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö', `‡∏•‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ "${p.name}" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`, () => {
                products = products.filter(x => x.id !== id);
                localStorage.setItem('pos-products', JSON.stringify(products));
                loadStockList();
                showSuccessModal('‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß');
                checkLowStockAlert();
                if (document.getElementById('history-page').classList.contains('hidden') === false) {
                    loadHistory();
                }
            }, true);
        }
        function renderHistoryTable(data) {
            const container = document.getElementById('history-body');
            container.innerHTML = '';
            if (data.length === 0) {
                container.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-500">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
                return;
            }
            data.forEach(r => {
                const rd = new Date(r.date);
                const tr = document.createElement('tr');
                const isReturned = r.status === 'returned';
                tr.className = isReturned ? 'bg-red-100 opacity-60' : '';

                let actionsHtml = '';
                if (isReturned) {
                    actionsHtml = `<td class="px-4 py-2 text-center"><span class="font-bold text-red-700">‡∏Ñ‡∏∑‡∏ô‡πÅ‡∏•‡πâ‡∏ß</span></td>`;
                } else {
                    actionsHtml = `
                    <td class="px-4 py-2 text-center">
                        <div class="flex justify-center space-x-1">
                            <button onclick="printReceiptById('${r.id}')" class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs" title="‡∏û‡∏¥‡∏°‡∏û‡πå">üñ®Ô∏è</button>
                            <button onclick="processReturn('${r.id}')" class="bg-yellow-500 hover:bg-yellow-600 text-white px-2 py-1 rounded text-xs" title="‡∏Ñ‡∏∑‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤">‚Ü©Ô∏è</button>
                            <button onclick="deleteSale('${r.id}')" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs" title="‡∏•‡∏ö">üóëÔ∏è</button>
                        </div>
                    </td>`;
                }

                tr.innerHTML = `
                    <td class="px-4 py-2 ${isReturned ? 'line-through' : ''}">${rd.toLocaleDateString('th-TH')}<br>${rd.toLocaleTimeString('th-TH')}</td>
                    <td class="px-4 py-2 ${isReturned ? 'line-through' : ''}">${r.id}</td>
                    <td class="px-4 py-2 ${isReturned ? 'line-through' : ''}">${r.items.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td>
                    <td class="px-4 py-2 text-right ${isReturned ? 'line-through' : ''}">‡∏ø${r.total.toFixed(2)}</td>
                    <td class="px-4 py-2 text-right font-semibold text-green-600 ${isReturned ? 'line-through' : ''}">‡∏ø${(r.totalProfit || 0).toFixed(2)}</td>
                    <td class="px-4 py-2 ${isReturned ? 'line-through' : ''}">${r.paymentMethod === 'cash' ? '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î' : 'QR'}</td>
                    ${actionsHtml}
                `;
                container.appendChild(tr);
            });
        }

        function printReceiptById(receiptId) {
            const receipt = salesHistory.find(r => r.id === receiptId);
            if(receipt) {
                printReceipt(receipt);
            }
        }

        function deleteSale(receiptId) {
            const saleIndex = salesHistory.findIndex(r => r.id === receiptId);
            if (saleIndex === -1) return;

            showWarningModal('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö', `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ${receiptId} ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ`, () => {
                salesHistory.splice(saleIndex, 1);
                localStorage.setItem('pos-history', JSON.stringify(salesHistory));
                loadHistory();
                showSuccessModal('‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', `‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ${receiptId} ‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß`);
            }, true);
        }

        function processReturn(receiptId) {
            const receipt = salesHistory.find(r => r.id === receiptId);
            if (!receipt || receipt.status === 'returned') return;

            showWarningModal('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', `‡∏Ñ‡∏∑‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ${receiptId} ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏ï‡πá‡∏≠‡∏Å`, () => {
                receipt.items.forEach(item => {
                    const product = products.find(p => p.id === item.id);
                    if (product) {
                        const oldStock = product.stock;
                        product.stock += item.quantity;
                        recordStockChange(product.id, product.name, product.code, item.quantity, oldStock, product.stock, `‡∏Ñ‡∏∑‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à ${receipt.id})`);
                    }
                });

                receipt.status = 'returned';

                localStorage.setItem('pos-products', JSON.stringify(products));
                localStorage.setItem('pos-history', JSON.stringify(salesHistory));

                loadHistory();
                showSuccessModal('‡∏Ñ‡∏∑‡∏ô‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ñ‡∏π‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß');
            }, true);
        }

        function loadHistory() {
            renderHistoryTable(salesHistory);
            updateSalesSummary();
            filterByMonth();
        }

        function searchHistory() {
            const term = document.getElementById('sales-history-search').value.toLowerCase();
            const date = document.getElementById('sales-date-filter').value;
            let filtered = salesHistory;

            if (date) {
                filtered = filtered.filter(r => r.date.startsWith(date));
            }
            if (term) {
                filtered = filtered.filter(r =>
                    r.id.toLowerCase().includes(term) ||
                    r.items.some(i => i.name.toLowerCase().includes(term))
                );
            }
            renderHistoryTable(filtered);
        }

        function updateSalesSummary() {
            const validSales = salesHistory.filter(r => r.status !== 'returned');

            const today = new Date();
            const startOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate());

            const dailySales = validSales.filter(r => new Date(r.date) >= startOfDay);
            const dailyTotal = dailySales.reduce((sum, r) => sum + r.total, 0);
            const dailyProfit = dailySales.reduce((sum, r) => sum + (r.totalProfit || 0), 0);

            document.getElementById('daily-sales').textContent = `‡∏ø${dailyTotal.toFixed(2)}`;
            document.getElementById('daily-count').textContent = `${dailySales.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
            document.getElementById('daily-profit').textContent = `‡∏Å‡∏≥‡πÑ‡∏£: ‡∏ø${dailyProfit.toFixed(2)}`;

            const dailyProductSummary = {};
            dailySales.forEach(receipt => {
                receipt.items.forEach(item => {
                    const name = item.name || '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö';
                    if (!dailyProductSummary[name]) {
                        dailyProductSummary[name] = { quantity: 0, amount: 0 };
                    }
                    dailyProductSummary[name].quantity += item.quantity;
                    dailyProductSummary[name].amount += item.price * item.quantity;
                });
            });

            const dailyEntries = Object.entries(dailyProductSummary)
                .sort((a, b) => b[1].amount - a[1].amount)
                .slice(0, 5);

            const dailyMax = dailyEntries.length > 0 ? Math.max(...dailyEntries.map(([_, stats]) => stats.amount)) : 1;

            const dailySummaryHtml = dailyEntries.length > 0
                ? dailyEntries.map(([name, stats]) => {
                    const width = (stats.amount / dailyMax) * 100;
                    const color = `rgba(59, 130, 246, ${0.4 + 0.6 * (width / 100)})`;
                    return `
                        <div class="mt-1">
                            <p class="font-medium">‚Ä¢ ${name}: ${stats.quantity} ‡∏ä‡∏¥‡πâ‡∏ô (‡∏ø${stats.amount.toLocaleString()})</p>
                            <div class="mini-bar">
                                <div class="mini-bar-fill" style="width: ${width}%; background-color: ${color};"></div>
                            </div>
                        </div>
                    `;
                }).join('')
                : '<p class="text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</p>';

            document.getElementById('daily-product-summary').innerHTML = dailySummaryHtml;
        }

        function filterByMonth() {
            const validSales = salesHistory.filter(r => r.status !== 'returned');

            const month = parseInt(document.getElementById('month-filter').value);
            const year = parseInt(document.getElementById('year-filter').value);
            const startDate = new Date(year, month - 1, 1);
            const endDate = new Date(year, month, 0, 23, 59, 59, 999);

            const monthlySales = validSales.filter(r => {
                const d = new Date(r.date);
                return d >= startDate && d <= endDate;
            });

            const monthlyTotal = monthlySales.reduce((sum, r) => sum + r.total, 0);
            const monthlyProfit = monthlySales.reduce((sum, r) => sum + (r.totalProfit || 0), 0);

            document.getElementById('monthly-sales').textContent = `‡∏ø${monthlyTotal.toFixed(2)}`;
            document.getElementById('monthly-count').textContent = `${monthlySales.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`;
            document.getElementById('monthly-profit').textContent = `‡∏Å‡∏≥‡πÑ‡∏£: ‡∏ø${monthlyProfit.toFixed(2)}`;

            const monthlyProductSummary = {};
            monthlySales.forEach(receipt => {
                receipt.items.forEach(item => {
                    const name = item.name || '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö';
                    if (!monthlyProductSummary[name]) {
                        monthlyProductSummary[name] = { quantity: 0, amount: 0 };
                    }
                    monthlyProductSummary[name].quantity += item.quantity;
                    monthlyProductSummary[name].amount += item.price * item.quantity;
                });
            });

            const monthlyEntries = Object.entries(monthlyProductSummary)
                .sort((a, b) => b[1].amount - a[1].amount)
                .slice(0, 5);

            const monthlyMax = monthlyEntries.length > 0 ? Math.max(...monthlyEntries.map(([_, stats]) => stats.amount)) : 1;

            const monthlySummaryHtml = monthlyEntries.length > 0
                ? monthlyEntries.map(([name, stats]) => {
                    const width = (stats.amount / monthlyMax) * 100;
                    const color = `rgba(129, 140, 248, ${0.4 + 0.6 * (width / 100)})`; // Indigo color
                    return `
                        <div class="mt-1">
                            <p class="font-medium">‚Ä¢ ${name}: ${stats.quantity} ‡∏ä‡∏¥‡πâ‡∏ô (‡∏ø${stats.amount.toLocaleString()})</p>
                            <div class="mini-bar">
                                <div class="mini-bar-fill" style="width: ${width}%; background-color: ${color};"></div>
                            </div>
                        </div>
                    `;
                }).join('')
                : '<p class="text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</p>';

            document.getElementById('monthly-product-summary').innerHTML = monthlySummaryHtml;
        }

        function exportCSV() {
            if (salesHistory.length === 0) {
                showWarningModal('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å');
                return;
            }
            const csv = [
                ['‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà', '‡πÄ‡∏ß‡∏•‡∏≤', '‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô', '‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢', '‡∏ï‡πâ‡∏ô‡∏ó‡∏∏‡∏ô‡∏ï‡πà‡∏≠‡∏´‡∏ô‡πà‡∏ß‡∏¢', '‡∏Å‡∏≥‡πÑ‡∏£‡∏ï‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', '‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°', '‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à', '‡∏Å‡∏≥‡πÑ‡∏£‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à', '‡∏ä‡∏≥‡∏£‡∏∞‡πÇ‡∏î‡∏¢', '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞'].join(',')
            ];
            salesHistory.forEach(r => {
                const d = new Date(r.date);
                r.items.forEach(item => {
                    const itemProfit = (item.price - (item.cost || 0)) * item.quantity;
                     csv.push([
                        `"${r.id}"`,
                        d.toLocaleDateString('en-CA'),
                        d.toLocaleTimeString('en-GB'),
                        `"${item.name}"`,
                        item.quantity,
                        item.price,
                        item.cost || 0,
                        itemProfit,
                        (item.quantity * item.price),
                        r.total,
                        r.totalProfit || 0,
                        r.paymentMethod,
                        r.status || 'completed'
                    ].join(','));
                });
            });
            const blob = new Blob([`\uFEFF${csv.join('\n')}`], { type: 'text/csv;charset=utf-8;' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `pos-sales-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            showSuccessModal('‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡πÑ‡∏ü‡∏•‡πå CSV ‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß');
        }

        function clearHistory() {
            showWarningModal('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á', '‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ', () => {
                salesHistory = [];
                localStorage.removeItem('pos-history');
                loadHistory();
                showSuccessModal('‡∏•‡πâ‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß');
            }, true);
        }

        function checkStockHistoryPassword() {
            const p = document.getElementById('stock-history-password').value;
            if (!p) {
                showErrorModal('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô', '‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö');
                return;
            }
            showLoadingModal('‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...');
            setTimeout(() => {
                if (p === settings.password) {
                    document.getElementById('stock-history-login').classList.add('hidden');
                    document.getElementById('stock-history-main').classList.remove('hidden');
                    filterStockHistoryByMonth();
                    showSuccessModal('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö');
                } else {
                    showErrorModal('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', '‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
                    document.getElementById('stock-history-password').value = '';
                }
            }, 1000);
        }

        function renderStockHistoryTable(data) {
            const container = document.getElementById('stock-history-body');
            container.innerHTML = '';
            if (data.length === 0) {
                container.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</td></tr>';
                return;
            }
            data.forEach(h => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-4 py-2">${formatDate(h.date)}</td>
                    <td class="px-4 py-2">${h.time}</td>
                    <td class="px-4 py-2">${h.productName}</td>
                    <td class="px-4 py-2">${h.productCode}</td>
                    <td class="px-4 py-2 text-center font-bold ${h.change > 0 ? 'text-green-600' : 'text-red-600'}">${h.change > 0 ? '+' : ''}${h.change}</td>
                    <td class="px-4 py-2 text-center">${h.oldStock} ‚Üí ${h.newStock}</td>
                    <td class="px-4 py-2">${h.reason}</td>
                `;
                container.appendChild(tr);
            });
        }

        function filterStockHistoryByMonth() {
            const month = parseInt(document.getElementById('stock-history-month-filter').value);
            const year = parseInt(document.getElementById('stock-history-year-filter').value);
            const startDate = new Date(year, month - 1, 1);
            const endDate = new Date(year, month, 0, 23, 59, 59, 999);

            const monthlyHistory = stockHistory.filter(h => {
                const d = new Date(h.date);
                return d >= startDate && d <= endDate;
            });

            let stockIn = 0;
            let stockOut = 0;

            monthlyHistory.forEach(h => {
                if (h.change > 0) {
                    stockIn += h.change;
                } else {
                    stockOut += Math.abs(h.change);
                }
            });

            document.getElementById('monthly-stock-in').textContent = stockIn;
            document.getElementById('monthly-stock-out').textContent = stockOut;

            renderStockHistoryTable(monthlyHistory);
        }

        function clearAllStockHistory() {
            showWarningModal('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á', '‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ', () => {
                stockHistory = [];
                localStorage.removeItem('pos-stock-history');
                filterStockHistoryByMonth();
                showSuccessModal('‡∏•‡πâ‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß');
            }, true);
        }
        function loadSettings() {
            document.getElementById('shop-name').value = settings.shopName;
            document.getElementById('shop-address').value = settings.shopAddress;
            document.getElementById('shop-phone').value = settings.shopPhone;
            document.getElementById('shop-tax').value = settings.shopTax;
            document.getElementById('low-stock-threshold').value = settings.lowStockThreshold;
            document.getElementById('vat-rate').value = settings.vatRate;
            document.getElementById('vat-rate-display').textContent = settings.vatRate;
        }
        function saveSettings() {
            settings.shopName = document.getElementById('shop-name').value || '‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô';
            settings.shopAddress = document.getElementById('shop-address').value || '‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà';
            settings.shopPhone = document.getElementById('shop-phone').value || '000-000-0000';
            settings.shopTax = document.getElementById('shop-tax').value || '1234567890123';
            const threshold = parseInt(document.getElementById('low-stock-threshold').value);
            if (!isNaN(threshold) && threshold >= 0) {
                settings.lowStockThreshold = threshold;
            } else {
                settings.lowStockThreshold = 5;
            }
             const vatRate = parseFloat(document.getElementById('vat-rate').value);
            if (!isNaN(vatRate) && vatRate >= 0) {
                settings.vatRate = vatRate;
            } else {
                settings.vatRate = 7;
            }
            localStorage.setItem('pos-settings', JSON.stringify(settings));
            document.getElementById('vat-rate-display').textContent = settings.vatRate;
            showSuccessModal('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß');
            checkLowStockAlert();
            updateCart();
        }
        function changePassword() {
            const curr = document.getElementById('current-password').value;
            const newP = document.getElementById('new-password').value;
            if (curr !== settings.password) {
                showErrorModal('‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏¥‡∏î', '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                return;
            }
            if (newP.length < 4) {
                showErrorModal('‡∏£‡∏´‡∏±‡∏™‡∏™‡∏±‡πâ‡∏ô‡πÄ‡∏Å‡∏¥‡∏ô', '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 4 ‡∏ï‡∏±‡∏ß');
                return;
            }
            settings.password = newP;
            localStorage.setItem('pos-settings', JSON.stringify(settings));
            document.getElementById('current-password').value = '';
            document.getElementById('new-password').value = '';
            showSuccessModal('‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß');
        }
        function exportData() {
            const data = {
                products,
                salesHistory,
                stockHistory,
                settings,
                receiptCounter,
                financeTransactions,
                financeBalances,
                heldCarts, // --- NEW: Add held carts to backup ---
                timestamp: new Date().toISOString()
            };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `pos-backup-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = e => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = async () => {
                    try {
                        const data = JSON.parse(reader.result);
                        products = data.products || [];
                        salesHistory = data.salesHistory || [];
                        stockHistory = data.stockHistory || [];
                        settings = data.settings || settings;
                        receiptCounter = data.receiptCounter || 1;
                        financeTransactions = data.financeTransactions || [];
                        financeBalances = data.financeBalances || { cash: 0, bank: 0 };
                        heldCarts = data.heldCarts || []; // --- NEW: Restore held carts ---

                        localStorage.setItem('pos-products', JSON.stringify(products));
                        localStorage.setItem('pos-history', JSON.stringify(salesHistory));
                        localStorage.setItem('pos-stock-history', JSON.stringify(stockHistory));
                        localStorage.setItem('pos-settings', JSON.stringify(settings));
                        localStorage.setItem('pos-receipt-counter', receiptCounter);
                        localStorage.setItem('pos-finance', JSON.stringify(financeTransactions));
                        localStorage.setItem('pos-finance-balances', JSON.stringify(financeBalances));
                        localStorage.setItem('pos-held-carts', JSON.stringify(heldCarts)); // --- NEW ---


                        loadSettings();
                        refreshProducts();
                        updateHeldCartCount();
                        showSuccessModal('‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß');
                        checkLowStockAlert();
                    } catch (err) {
                        showErrorModal('‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏™‡∏µ‡∏¢‡∏´‡∏≤‡∏¢');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        // --- NEW FEATURE: Dashboard ---
        function updateDashboard() {
            const validSales = salesHistory.filter(r => r.status !== 'returned');
            
            // 1. Key Metrics
            const today = new Date();
            const startOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate());
            const dailySales = validSales.filter(r => new Date(r.date) >= startOfDay);
            const dailyTotal = dailySales.reduce((sum, r) => sum + r.total, 0);
            const dailyProfit = dailySales.reduce((sum, r) => sum + (r.totalProfit || 0), 0);

            document.getElementById('dashboard-daily-sales').textContent = `‡∏ø${dailyTotal.toFixed(2)}`;
            document.getElementById('dashboard-daily-profit').textContent = `‡∏ø${dailyProfit.toFixed(2)}`;
            document.getElementById('dashboard-daily-transactions').textContent = dailySales.length;
            document.getElementById('dashboard-total-products').textContent = products.length;

            // 2. Best Sellers (Monthly)
            const month = today.getMonth();
            const year = today.getFullYear();
            const startOfMonth = new Date(year, month, 1);
            const endOfMonth = new Date(year, month + 1, 0, 23, 59, 59);
            const monthlySales = validSales.filter(r => new Date(r.date) >= startOfMonth && new Date(r.date) <= endOfMonth);
            const productSummary = {};
            monthlySales.forEach(r => {
                r.items.forEach(i => {
                    productSummary[i.name] = (productSummary[i.name] || 0) + i.quantity;
                });
            });
            const bestSellers = Object.entries(productSummary).sort((a, b) => b[1] - a[1]).slice(0, 5);
            const bestSellersContainer = document.getElementById('dashboard-best-sellers');
            bestSellersContainer.innerHTML = '';
            if(bestSellers.length > 0) {
                bestSellers.forEach(([name, qty]) => {
                    bestSellersContainer.innerHTML += `<p class="text-sm">‚Ä¢ ${name}: <span class="font-semibold">${qty} ‡∏ä‡∏¥‡πâ‡∏ô</span></p>`;
                });
            } else {
                 bestSellersContainer.innerHTML = `<p class="text-sm text-gray-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>`;
            }

            // 3. Low Stock Items
            const lowStockItems = products.filter(p => p.stock > 0 && p.stock <= settings.lowStockThreshold);
            const lowStockContainer = document.getElementById('dashboard-low-stock');
            lowStockContainer.innerHTML = '';
            if (lowStockItems.length > 0) {
                 lowStockItems.slice(0, 5).forEach(p => {
                    lowStockContainer.innerHTML += `<p class="text-sm">‚Ä¢ ${p.name}: <span class="font-semibold text-red-600">${p.stock} ‡∏ä‡∏¥‡πâ‡∏ô</span></p>`;
                });
            } else {
                 lowStockContainer.innerHTML = `<p class="text-sm text-gray-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ï‡πà‡∏≥</p>`;
            }
            
            // 4. Sales Chart (Last 7 Days)
            const chartData = {
                labels: [],
                sales: []
            };
            for(let i=6; i>=0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                const dayStr = d.toISOString().split('T')[0];
                const shortDay = d.toLocaleDateString('th-TH', { weekday: 'short' });
                chartData.labels.push(shortDay);
                
                const salesOnDay = validSales
                    .filter(r => r.date.startsWith(dayStr))
                    .reduce((sum, r) => sum + r.total, 0);
                chartData.sales.push(salesOnDay);
            }

            const ctx = document.getElementById('salesChart').getContext('2d');
            if(salesChartInstance) {
                salesChartInstance.destroy();
            }
            salesChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chartData.labels,
                    datasets: [{
                        label: '‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢',
                        data: chartData.sales,
                        backgroundColor: 'rgba(59, 130, 246, 0.5)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 1,
                        borderRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        // --- NEW FEATURE: Z-Report (End of Day) ---
        function printZReport() {
            const todayStr = new Date().toISOString().split('T')[0];
            const date = prompt("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏ß‡∏±‡∏ô (YYYY-MM-DD):", todayStr);
            if (!date) return;

            const salesForDay = salesHistory.filter(r => r.date.startsWith(date) && r.status !== 'returned');
            if (salesForDay.length === 0) {
                showWarningModal('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', `‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${date}`);
                return;
            }

            const totalSales = salesForDay.reduce((sum, r) => sum + r.total, 0);
            const totalProfit = salesForDay.reduce((sum, r) => sum + (r.totalProfit || 0), 0);
            const totalTransactions = salesForDay.length;
            const paymentMethods = salesForDay.reduce((acc, r) => {
                acc[r.paymentMethod] = (acc[r.paymentMethod] || 0) + r.total;
                return acc;
            }, {});

            const allItems = salesForDay.flatMap(r => r.items);
            const productSummary = allItems.reduce((acc, item) => {
                if (!acc[item.name]) {
                    acc[item.name] = { quantity: 0, total: 0 };
                }
                acc[item.name].quantity += item.quantity;
                acc[item.name].total += item.price * item.quantity;
                return acc;
            }, {});

            let productSummaryHtml = Object.entries(productSummary).map(([name, data]) => 
                `<tr><td style="text-align:left;">${name}</td><td style="text-align:center;">${data.quantity}</td><td style="text-align:right;">‡∏ø${data.total.toFixed(2)}</td></tr>`
            ).join('');

            const div = document.getElementById('receipt-print');
            const printDate = new Date().toLocaleString('th-TH');
            const reportDate = new Date(date).toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric'});

             div.innerHTML = `
                <div style="text-align:center;margin-bottom:10px;">
                    <h2>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏™‡∏¥‡πâ‡∏ô‡∏ß‡∏±‡∏ô (Z-Report)</h2>
                    <p><strong>${settings.shopName}</strong></p>
                    <p>‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${reportDate}</p>
                    <p>‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${printDate}</p>
                </div>
                <hr>
                <h3 style="margin-bottom:5px;">‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°</h3>
                <p><strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ö‡∏¥‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</strong> ${totalTransactions} ‡∏ö‡∏¥‡∏•</p>
                <p><strong>‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°:</strong> ‡∏ø${totalSales.toFixed(2)}</p>
                <p style="color:green;"><strong>‡∏Å‡∏≥‡πÑ‡∏£‡∏£‡∏ß‡∏° (‡πÇ‡∏î‡∏¢‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì):</strong> ‡∏ø${totalProfit.toFixed(2)}</p>
                <hr>
                <h3 style="margin-bottom:5px;">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h3>
                ${Object.entries(paymentMethods).map(([method, total]) => `<p><strong>${method === 'cash' ? '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î' : 'QR Code'}:</strong> ‡∏ø${total.toFixed(2)}</p>`).join('')}
                <hr>
                <h3 style="margin-bottom:5px;">‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ï‡∏≤‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
                <table style="width:100%; border-collapse: collapse;">
                    <thead><tr><th style="text-align:left;">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th style="text-align:center;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th style="text-align:right;">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</th></tr></thead>
                    <tbody>${productSummaryHtml}</tbody>
                </table>
                <hr>
                <p style="text-align:center;margin-top:20px;">--- ‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô ---</p>
            `;
            div.classList.remove('hidden');
            window.print();
            div.classList.add('hidden');
        }


        function showLoadingModal(message) {
            const modal = document.getElementById('modal-overlay');
            const title = document.getElementById('modal-title');
            const messageEl = document.getElementById('modal-message');
            const icon = document.getElementById('modal-icon');
            const buttons = document.getElementById('modal-buttons');
            title.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...';
            messageEl.innerHTML = message;
            icon.textContent = '‚è≥';
            buttons.innerHTML = '';
            modal.classList.remove('hidden');
            modal.classList.add('show');
        }
        function showSuccessModal(title, message) {
            const modal = document.getElementById('modal-overlay');
            const titleEl = document.getElementById('modal-title');
            const messageEl = document.getElementById('modal-message');
            const icon = document.getElementById('modal-icon');
            const buttons = document.getElementById('modal-buttons');
            titleEl.textContent = title;
            messageEl.innerHTML = message;
            icon.textContent = '‚úÖ';
            buttons.innerHTML = '';
            const okButton = document.createElement('button');
            okButton.className = 'bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg';
            okButton.textContent = '‡∏ï‡∏Å‡∏•‡∏á';
            okButton.onclick = closeModal;
            buttons.appendChild(okButton);
            modal.classList.remove('hidden');
            modal.classList.add('show');
        }
        function showErrorModal(title, message) {
            const modal = document.getElementById('modal-overlay');
            const titleEl = document.getElementById('modal-title');
            const messageEl = document.getElementById('modal-message');
            const icon = document.getElementById('modal-icon');
            const buttons = document.getElementById('modal-buttons');
            titleEl.textContent = title;
            messageEl.innerHTML = message;
            icon.textContent = '‚ùå';
            buttons.innerHTML = '';
            const okButton = document.createElement('button');
            okButton.className = 'bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg';
            okButton.textContent = '‡∏ï‡∏Å‡∏•‡∏á';
            okButton.onclick = closeModal;
            buttons.appendChild(okButton);
            modal.classList.remove('hidden');
            modal.classList.add('show');
        }
        function showWarningModal(title, message, onConfirm, showCancel = false) {
            const modal = document.getElementById('modal-overlay');
            const titleEl = document.getElementById('modal-title');
            const messageEl = document.getElementById('modal-message');
            const icon = document.getElementById('modal-icon');
            const buttons = document.getElementById('modal-buttons');
            titleEl.textContent = title;
            messageEl.innerHTML = message;
            icon.textContent = '‚ö†Ô∏è';
            buttons.innerHTML = '';
            if (showCancel) {
                const cancelButton = document.createElement('button');
                cancelButton.className = 'bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg mr-2';
                cancelButton.textContent = '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å';
                cancelButton.onclick = closeModal;
                buttons.appendChild(cancelButton);
            }
            const confirmButton = document.createElement('button');
            confirmButton.className = 'bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-lg';
            confirmButton.textContent = '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô';
            confirmButton.onclick = () => {
                closeModal();
                if (onConfirm) onConfirm();
            };
            buttons.appendChild(confirmButton);
            modal.classList.remove('hidden');
            modal.classList.add('show');
        }
        function closeModal() {
            const modal = document.getElementById('modal-overlay');
            modal.classList.remove('show');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }
        function openDateRangeModal(type) {
            currentReportType = type;
            document.getElementById('date-range-modal').classList.remove('hidden');
            setTimeout(() => document.getElementById('start-date').focus(), 300);
        }
        function closeDateRangeModal() {
            document.getElementById('date-range-modal').classList.add('hidden');
            document.getElementById('start-date').value = '';
            document.getElementById('end-date').value = '';
        }
        function confirmDateRange() {
            const start = document.getElementById('start-date').value;
            const end = document.getElementById('end-date').value;
            if (!start || !end) {
                showErrorModal('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î');
                return;
            }
            if (start > end) {
                showErrorModal('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î');
                return;
            }
            printReportByDateRange(currentReportType, start, end);
            closeDateRangeModal();
        }

        function printReportByDateRange(type, start, end) {
            const startDate = new Date(start);
            const endDate = new Date(end);
            endDate.setHours(23, 59, 59, 999);

            const formatThaiDate = (date) => {
                const d = new Date(date);
                return d.toLocaleDateString('th-TH', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            };

            let title, data, renderFn;
            const printDate = new Date().toLocaleString('th-TH');

            const headerHtml = `
                <div style="text-align:center;margin-bottom:10px;">
                    <h2>${settings.shopName}</h2>
                    <p>${settings.shopAddress}</p>
                    <p>‡πÇ‡∏ó‡∏£: ${settings.shopPhone}</p>
                </div>
                <hr>`;

            if (type === 'sales') {
                data = salesHistory.filter(r => {
                    const d = new Date(r.date);
                    return d >= startDate && d <= endDate && r.status !== 'returned';
                });

                if (data.length === 0) {
                    showWarningModal('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å');
                    return;
                }

                const totalAmount = data.reduce((sum, r) => sum + r.total, 0);
                const totalProfit = data.reduce((sum, r) => sum + (r.totalProfit || 0), 0);
                title = `‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢`;
                const dateRange = `‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${formatThaiDate(start)} - ${formatThaiDate(end)}`;

                renderFn = () => {
                    let rows = '';
                    data.sort((a,b) => new Date(a.date) - new Date(b.date)).forEach(r => {
                        const date = new Date(r.date);
                        r.items.forEach((item, index) => {
                             const itemProfit = (item.price - (item.cost || 0)) * item.quantity;
                             rows += `
                                <tr>
                                    ${index === 0 ? `
                                        <td rowspan="${r.items.length}" style="vertical-align: top;">${date.toLocaleDateString('th-TH')}<br>${date.toLocaleTimeString('th-TH')}</td>
                                        <td rowspan="${r.items.length}" style="vertical-align: top;">${r.id}</td>
                                    ` : ''}
                                    <td style="text-align:left;">${item.name}</td>
                                    <td style="text-align:center;">${item.quantity}</td>
                                    <td style="text-align:right;">‡∏ø${item.price.toFixed(2)}</td>
                                    <td style="text-align:right; color: green;">‡∏ø${itemProfit.toFixed(2)}</td>
                                    ${index === 0 ? `
                                        <td rowspan="${r.items.length}" style="vertical-align: top; text-align:right; font-weight:bold;">‡∏ø${r.total.toFixed(2)}</td>
                                    ` : ''}
                                </tr>
                            `;
                        });
                    });

                    return `
                        <h3 style="text-align:center; margin-bottom: 0;">${title}</h3>
                        <p style="text-align:center; margin-top: 0;">${dateRange}</p>
                        <p><strong>‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠:</strong> ${printDate}</p><hr>
                        <table style="width:100%;font-size:11px; border-collapse: collapse;">
                            <thead>
                                <tr style="border-bottom: 1px solid #000;">
                                    <th style="width:15%; text-align:left; padding-bottom: 5px;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤</th>
                                    <th style="width:12%; text-align:left; padding-bottom: 5px;">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th>
                                    <th style="width:35%; text-align:left; padding-bottom: 5px;">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                                    <th style="width:8%; text-align:center; padding-bottom: 5px;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                                    <th style="width:10%; text-align:right; padding-bottom: 5px;">‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏´‡∏ô‡πà‡∏ß‡∏¢</th>
                                    <th style="width:10%; text-align:right; padding-bottom: 5px;">‡∏Å‡∏≥‡πÑ‡∏£</th>
                                    <th style="width:10%; text-align:right; padding-bottom: 5px;">‡∏¢‡∏≠‡∏î‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${rows}
                            </tbody>
                        </table>
                        <hr>
                        <p style="text-align:right; font-size: 14px;"><strong>‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°: ‡∏ø${totalAmount.toFixed(2)}</strong></p>
                        <p style="text-align:right; font-size: 14px; color: green;"><strong>‡∏Å‡∏≥‡πÑ‡∏£‡∏£‡∏ß‡∏°: ‡∏ø${totalProfit.toFixed(2)}</strong></p>
                    `;
                };
            }
            else if (type === 'stock-history') {
                data = stockHistory.filter(h => {
                    const d = new Date(h.date);
                    return d >= startDate && d <= endDate;
                });
                if (data.length === 0) {
                    showWarningModal('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏™‡∏ï‡πá‡∏≠‡∏Å‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å');
                    return;
                }
                title = `‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏™‡∏ï‡πá‡∏≠‡∏Å`;
                const dateRange = `‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${formatThaiDate(start)} - ${formatThaiDate(end)}`;
                renderFn = () => `
                    <h3 style="text-align:center; margin-bottom: 0;">${title}</h3>
                    <p style="text-align:center; margin-top: 0;">${dateRange}</p>
                    <p><strong>‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠:</strong> ${printDate}</p><hr>
                    <table style="width:100%;font-size:11px; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 1px solid #000;">
                                <th style="text-align:left; padding-bottom: 5px;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤</th>
                                <th style="text-align:left; padding-bottom: 5px;">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th>
                                <th style="text-align:center; padding-bottom: 5px;">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á</th>
                                <th style="text-align:center; padding-bottom: 5px;">‡πÄ‡∏î‡∏¥‡∏°‚Üí‡πÉ‡∏´‡∏°‡πà</th>
                                <th style="text-align:left; padding-bottom: 5px;">‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.sort((a,b) => new Date(a.date) - new Date(b.date)).map(h => `
                                <tr style="border-bottom: 1px solid #eee;">
                                    <td style="padding: 4px 0;">${formatDate(h.date)} ${h.time}</td>
                                    <td style="padding: 4px 0;">${h.productName} (${h.productCode})</td>
                                    <td style="text-align:center; padding: 4px 0;" class="${h.change > 0 ? 'text-green-600' : 'text-red-600'}">${h.change > 0 ? '+' : ''}${h.change}</td>
                                    <td style="text-align:center; padding: 4px 0;">${h.oldStock} ‚Üí ${h.newStock}</td>
                                    <td style="padding: 4px 0;">${h.reason}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            }
            else if (type === 'finance') {
                data = financeTransactions.filter(t => {
                    const d = new Date(t.date);
                    return d >= startDate && d <= endDate;
                });
                if (data.length === 0) {
                    showWarningModal('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å');
                    return;
                }
                const totalIncome = data.filter(t => t.type === '‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö').reduce((sum, t) => sum + parseFloat(t.amount), 0);
                const totalExpense = data.filter(t => t.type === '‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢').reduce((sum, t) => sum + parseFloat(t.amount), 0);
                const balance = totalIncome - totalExpense;
                title = `‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô`;
                const dateRange = `‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${formatThaiDate(start)} - ${formatThaiDate(end)}`;
                renderFn = () => `
                    <h3 style="text-align:center; margin-bottom: 0;">${title}</h3>
                    <p style="text-align:center; margin-top: 0;">${dateRange}</p>
                    <p><strong>‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠:</strong> ${printDate}</p><hr>
                    <table style="width:100%;font-size:11px; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 1px solid #000;">
                                <th style="text-align:left; padding-bottom: 5px;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                                <th style="text-align:left; padding-bottom: 5px;">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                                <th style="text-align:left; padding-bottom: 5px;">‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢</th>
                                <th style="text-align:right; padding-bottom: 5px;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.sort((a,b) => new Date(a.date) - new Date(b.date)).map(t => `
                                <tr style="border-bottom: 1px solid #eee;">
                                    <td style="padding: 4px 0;">${formatDate(t.date)}</td>
                                    <td style="padding: 4px 0;">${t.type} (${t.method})</td>
                                    <td style="padding: 4px 0;">${t.description || '-'}</td>
                                    <td style="text-align:right; padding: 4px 0;">‡∏ø${parseFloat(t.amount).toFixed(2)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table><hr>
                    <div style="text-align: right; font-size: 12px;">
                        <p><strong>‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏ß‡∏°:</strong> ‡∏ø${totalIncome.toFixed(2)}</p>
                        <p><strong>‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏£‡∏ß‡∏°:</strong> ‡∏ø${totalExpense.toFixed(2)}</p>
                        <p style="font-size: 14px;"><strong>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ô‡∏µ‡πâ: ‡∏ø${balance.toFixed(2)}</strong></p>
                    </div>
                `;
            }

            const div = document.getElementById('receipt-print');
            div.innerHTML = `${headerHtml}${renderFn()}<p style="text-align:center;margin-top:10px;font-style:italic;">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÇ‡∏î‡∏¢‡∏£‡∏∞‡∏ö‡∏ö POS</p>`;
            div.classList.remove('hidden');
            window.print();
            div.classList.add('hidden');
        }

    </script>
</body>
</html>
