<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CCKC ‡∏ä‡∏¥‡∏Å‡∏ä‡∏¥‡∏Å‡πÄ‡∏Å‡πâ‡∏ô‡∏â‡∏µ‡∏Å</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; box-sizing: border-box; }
        .gradient-bg { background: linear-gradient(135deg, #7e0707a6 0%, #c50202e5 0%); }
        .card-bg { background: linear-gradient(135deg, #920101 0%, #8a0000 100%); }
        .card-shadow { box-shadow: 0 10px 25px rgb(116, 0, 0); }
        .btn-primary { background: linear-gradient(135deg, #0065fd 0%, #0065fd 100%); transition: all 0.3s ease; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 20px #46ff3f(42, 126, 3); }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        @media print {
            body > *:not(#receipt-for-pc) {
                display: none;
            }
            #receipt-for-pc {
                display: block !important;
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
            }
        }
    </style>
</head>
<body class="bg-gray-700 min-h-screen">
    <div id="app-container">
        <div class="gradient-bg text-white py-6 px-4">
            <div class="max-w-md mx-auto text-center">
                <img src="S__63103005.jpg" style="display: block ; margin: 0px auto; width: 20%; height: 20%;">
                <h1 class="text-2xl font-bold mb-2">üçú CCKC ‡∏ä‡∏¥‡∏Å‡∏ä‡∏¥‡∏Å‡πÄ‡∏Å‡πâ‡∏ô‡∏â‡∏µ‡∏Å üçú </h1>
                <p class="text-blue-100">üçú ‡∏Ç‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤   ‡∏¢‡∏≥‡∏´‡∏°‡∏µ‡πà‡πÑ‡∏Å‡πà‡∏â‡∏µ‡∏Å üçú</p>
            </div>
        </div>

        <div class="max-w-md mx-auto bg-gray-900 card-shadow -mt-4 rounded-t-3xl relative z-10">
            <div class="flex border-b border-gray-700">
                <button id="saleTab" class="flex-1 py-4 px-6 text-center font-medium text-blue-400 border-b-2 border-blue-400 bg-gray-800">üìù ‡∏Ç‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</button>
                <button id="historyTab" class="flex-1 py-4 px-6 text-center font-medium text-gray-400 hover:text-blue-400 transition-colors">üìä ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</button>
            </div>
        </div>

        <div id="saleForm" class="max-w-md mx-auto bg-gray-900 card-shadow rounded-b-3xl p-6 fade-in">
            <form id="salesForm" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-300 mb-3">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£:</label>
                    <div id="product-grid" class="grid grid-cols-2 gap-3">
                        </div>
                </div>

                <div id="cartSection" class="hidden">
                    <div class="bg-gray-800 p-4 rounded-xl border border-gray-700">
                        <div class="flex justify-between items-center mb-3">
                            <h4 class="font-medium text-gray-200">üõí ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h4>
                            <button type="button" id="clearCart" class="text-sm text-red-400 hover:text-red-500">‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                        </div>
                        <div id="cartItems" class="space-y-2"></div>
                    </div>
                </div>

                <div class="bg-gray-800 p-4 rounded-xl border border-gray-700">
                    <div class="flex justify-between items-center">
                        <span class="font-medium text-gray-200">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°:</span>
                        <span id="totalAmount" class="text-2xl font-bold text-blue-400">0 ‡∏ö‡∏≤‡∏ó</span>
                    </div>
                </div>

                <div class="bg-gray-800 p-4 rounded-xl border border-gray-700">
                    <h4 class="font-medium text-gray-200 mb-3">üí∞ ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h4>
                    <div class="mb-3">
                        <label class="block text-sm font-medium text-gray-300 mb-2">‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î (‡∏ö‡∏≤‡∏ó):</label>
                        <input type="number" id="receivedAmount" name="receivedAmount" min="0" step="1" class="w-full bg-gray-700 text-white border border-gray-600 rounded-lg py-2 px-3 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö">
                    </div>
                    <div class="grid grid-cols-4 gap-2 mb-3">
                        <button type="button" class="quick-amount bg-gray-700 text-gray-200 hover:bg-gray-600 py-2 px-3 rounded-lg text-sm font-medium transition-colors" data-amount="50">50</button>
                        <button type="button" class="quick-amount bg-gray-700 text-gray-200 hover:bg-gray-600 py-2 px-3 rounded-lg text-sm font-medium transition-colors" data-amount="100">100</button>
                        <button type="button" class="quick-amount bg-gray-700 text-gray-200 hover:bg-gray-600 py-2 px-3 rounded-lg text-sm font-medium transition-colors" data-amount="500">500</button>
                        <button type="button" class="quick-amount bg-gray-700 text-gray-200 hover:bg-gray-600 py-2 px-3 rounded-lg text-sm font-medium transition-colors" data-amount="1000">1000</button>
                    </div>
                    <div id="changeDisplay" class="hidden">
                        <div class="flex justify-between items-center p-3 bg-green-900 bg-opacity-50 rounded-lg border border-green-700">
                            <span class="font-medium text-green-300">‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏≠‡∏ô:</span>
                            <span id="changeAmount" class="text-xl font-bold text-green-400">0 ‡∏ö‡∏≤‡∏ó</span>
                        </div>
                    </div>
                    <div id="insufficientWarning" class="hidden p-3 bg-red-900 bg-opacity-50 rounded-lg border border-red-700">
                        <p class="text-sm text-red-400 text-center">‚ö†Ô∏è ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠</p>
                    </div>
                </div>

                <button type="submit" class="w-full btn-primary text-white py-3 px-6 rounded-xl font-medium">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</button>
            </form>

            <div class="mt-6 p-4 bg-gray-800 border border-gray-700 rounded-xl">
                <div class="flex justify-between items-center">
                    <h4 class="font-medium text-blue-300">üñ®Ô∏è ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå Bluetooth</h4>
                    <div id="printerStatus" class="text-xs px-2 py-1 rounded-full bg-gray-700 text-gray-300">‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</div>
                </div>
                <button id="connectPrinter" class="w-full bg-blue-500 hover:bg-blue-600 text-white py-2 px-4 rounded-lg text-sm font-medium transition-colors mt-2">üì± ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå</button>
            </div>

            <div class="mt-4 p-4 bg-gray-800 border border-gray-700 rounded-xl">
                <p class="text-sm text-green-400 text-center">üìä ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á Google Sheets ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>
                <p id="googleSheetStatus" class="text-xs text-center mt-1"></p>
            </div>
        </div>

        <div id="historyView" class="max-w-md mx-auto bg-gray-900 card-shadow rounded-b-3xl p-6 hidden">
            <h3 class="text-lg font-semibold text-gray-200 mb-2 text-center">üìä ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</h3>
            <div class="bg-gray-800 p-3 rounded-lg mb-4">
                <p class="text-sm text-gray-300 text-center">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ: <span id="todayTotal" class="font-bold text-green-400">0 ‡∏ö‡∏≤‡∏ó</span></p>
            </div>
            
            <div class="relative mb-4">
                <input type="text" id="searchInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≤‡∏° ID, ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£..." class="w-full pl-10 pr-4 py-2 bg-gray-700 text-white border border-gray-600 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                    </svg>
                </div>
            </div>

            <div id="salesHistory" class="space-y-3"></div>
            <div id="noHistory" class="text-center py-8 text-gray-500 hidden">
                <div class="text-4xl mb-2">üìù</div>
                <p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</p>
            </div>
        </div>
    </div>
    
    <div id="receipt-for-pc" class="hidden" style="width: 220px; font-family: 'Sarabun', sans-serif; color: #000; padding: 10px; font-size: 10pt;">
    </div>

<script>
// =================================================================
// SECTION: ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡∏∞‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏á‡∏ó‡∏µ‡πà (Configuration & Constants)
// =================================================================
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzHrURcZX9VNb1_Lic7BAxtBKGpTYwdLFDO8urZvWaEsRcSmgrgNvTANgc9QxXROyX6/exec';

    // <<< ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
    const products = [
        { id: 'yum_mee_50', name: '‡∏¢‡∏≥‡∏´‡∏°‡∏µ‡πà‡πÑ‡∏Å‡πà‡∏â‡∏µ‡∏Å (50 ‡∏ö‡∏≤‡∏ó)', price: 50, emoji: 'üçú', requiresType: true }, // ‡∏õ‡∏£‡∏±‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞ ID
        { id: 'yum_mee_30', name: '‡∏¢‡∏≥‡∏´‡∏°‡∏µ‡πà‡πÑ‡∏Å‡πà‡∏â‡∏µ‡∏Å (30 ‡∏ö‡∏≤‡∏ó)', price: 30, emoji: 'üçú', requiresType: true }, // <<< ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà
        { id: 'drinking_water', name: '‡∏ô‡πâ‡∏≥‡∏î‡∏∑‡πà‡∏°', price: 10, emoji: 'üíß', requiresType: false }, 
        { id: 'pork_crackling', name: '‡∏ô‡πâ‡∏≥‡∏û‡∏£‡∏¥‡∏Å‡∏Å‡∏≤‡∏Å‡∏´‡∏°‡∏π', price: 15, emoji: 'üå∂Ô∏è', requiresType: false },
        { id: 'extra_chicken', name: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏Å‡πà‡∏â‡∏µ‡∏Å', price: 10, emoji: 'üçó', requiresType: false },
        { id: 'extra_noodle', name: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏™‡πâ‡∏ô‡∏´‡∏°‡∏µ‡πà‡∏Ç‡∏≤‡∏ß', price: 10, emoji: 'üçù', requiresType: false }
        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà
        
    ];

    const addToCartSound = new Audio('button.mp3');
    const saleSuccessSound = new Audio('cash.mp3');
    const errorSound = new Audio('Del.mp3');
    const deleteSound = new Audio('error.mp3');

// =================================================================
// SECTION: ‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ç‡∏≠‡∏á‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô (Application State)
// =================================================================
    let salesData = JSON.parse(localStorage.getItem('salesData')) || [];
    let cart = [];
    let bluetoothCharacteristic = null;

// =================================================================
// SECTION: ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á DOM Elements
// =================================================================
    const saleTab = document.getElementById('saleTab');
    const historyTab = document.getElementById('historyTab');
    const saleForm = document.getElementById('saleForm');
    const historyView = document.getElementById('historyView');
    const salesForm = document.getElementById('salesForm');
    const totalAmount = document.getElementById('totalAmount');
    const receivedAmountInput = document.getElementById('receivedAmount');
    const changeDisplay = document.getElementById('changeDisplay');
    const changeAmount = document.getElementById('changeAmount');
    const insufficientWarning = document.getElementById('insufficientWarning');
    const cartSection = document.getElementById('cartSection');
    const cartItems = document.getElementById('cartItems');
    const clearCartBtn = document.getElementById('clearCart');
    const productGrid = document.getElementById('product-grid');
    const connectPrinterBtn = document.getElementById('connectPrinter');
    const googleSheetStatus = document.getElementById('googleSheetStatus');
    const salesHistoryContainer = document.getElementById('salesHistory');
    const searchInput = document.getElementById('searchInput');

// =================================================================
// SECTION: ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏•‡∏∞ Event Listeners
// =================================================================
    document.addEventListener('DOMContentLoaded', () => {
        renderProductButtons();
        updateCartDisplay();
        checkGoogleScriptUrl();
    });

    saleTab.addEventListener('click', () => switchTab('sale'));
    historyTab.addEventListener('click', () => switchTab('history'));
    clearCartBtn.addEventListener('click', clearCart);
    receivedAmountInput.addEventListener('input', calculateChange);
    connectPrinterBtn.addEventListener('click', connectBluetoothPrinter);
    salesForm.addEventListener('submit', handleFormSubmit);

    productGrid.addEventListener('click', (e) => {
        const productBtn = e.target.closest('.add-product-btn');
        if (productBtn) {
            const productId = productBtn.dataset.productId;
            const product = products.find(p => p.id === productId);
            showQuantityModal(product); 
        }
    });
    
    cartItems.addEventListener('click', (e) => {
        const target = e.target;
        const action = target.dataset.action;
        const itemId = parseFloat(target.dataset.itemId);
        if (action === 'increase') updateCartItemQuantity(itemId, 1);
        else if (action === 'decrease') updateCartItemQuantity(itemId, -1);
        else if (action === 'remove') removeFromCart(itemId);
    });

    document.querySelectorAll('.quick-amount').forEach(button => {
        button.addEventListener('click', () => {
            receivedAmountInput.value = button.dataset.amount;
            calculateChange();
        });
    });

    salesHistoryContainer.addEventListener('click', (e) => {
        const reprintBtn = e.target.closest('.reprint-btn');
        if (reprintBtn) {
            const saleId = parseInt(reprintBtn.dataset.saleId, 10);
            reprintReceipt(saleId);
            return;
        }

        const deleteBtn = e.target.closest('.delete-btn');
        if (deleteBtn) {
            const saleId = parseInt(deleteBtn.dataset.saleId, 10);
            deleteSaleRecord(saleId);
            return;
        }
    });

    searchInput.addEventListener('input', displayHistory);

// =================================================================
// SECTION: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô (Core Application Logic)
// =================================================================

    function renderProductButtons() {
        productGrid.innerHTML = products.map(product => `
            <button type="button" class="add-product-btn p-3 border border-gray-700 rounded-lg hover:bg-gray-800 hover:border-blue-500 cursor-pointer transition-colors text-left" 
                    data-product-id="${product.id}">
                <div class="font-medium text-white">${product.emoji} ${product.name}</div>
                <div class="text-sm text-blue-400 font-semibold">${product.price} ‡∏ö‡∏≤‡∏ó</div>
            </button>
        `).join('');
    }

    function switchTab(tab) {
        if (tab === 'sale') {
            saleTab.className = 'flex-1 py-4 px-6 text-center font-medium text-blue-400 border-b-2 border-blue-400 bg-gray-800';
            historyTab.className = 'flex-1 py-4 px-6 text-center font-medium text-gray-400 hover:text-blue-400 transition-colors';
            saleForm.classList.remove('hidden');
            historyView.classList.add('hidden');
        } else {
            historyTab.className = 'flex-1 py-4 px-6 text-center font-medium text-blue-400 border-b-2 border-blue-400 bg-gray-800';
            saleTab.className = 'flex-1 py-4 px-6 text-center font-medium text-gray-400 hover:text-blue-400 transition-colors';
            saleForm.classList.add('hidden');
            historyView.classList.remove('hidden');
            displayHistory();
        }
    }

    function addToCart(product, type = '', quantity = 1) {
        // <<< ‡∏ï‡∏£‡∏£‡∏Å‡∏∞‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏£‡∏≤‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠ '‡∏¢‡∏≥‡∏´‡∏°‡∏µ‡πà‡πÑ‡∏Å‡πà‡∏â‡∏µ‡∏Å (50 ‡∏ö‡∏≤‡∏ó)' ‡πÅ‡∏•‡∏∞ '‡∏¢‡∏≥‡∏´‡∏°‡∏µ‡πà‡πÑ‡∏Å‡πà‡∏â‡∏µ‡∏Å (30 ‡∏ö‡∏≤‡∏ó)' ‡πÉ‡∏´‡πâ‡∏ï‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô
        const existingItem = cart.find(item => item.product === product.name && item.type === type);
        if (existingItem) {
            existingItem.quantity += quantity; 
        } else {
            cart.push({
                id: Date.now() + Math.random(),
                product: product.name,
                price: product.price,
                emoji: product.emoji,
                type: type,
                quantity: quantity 
            });
        }
        addToCartSound.play();
        updateCartDisplay();
    }

    function clearCart() {
        if (cart.length > 0) {
            deleteSound.play();
        }
        cart = [];
        updateCartDisplay();
    }
    
    function removeFromCart(itemId) {
        cart = cart.filter(item => item.id !== itemId);
        updateCartDisplay();
    }

    function updateCartItemQuantity(itemId, change) {
        const item = cart.find(item => item.id === itemId);
        if (item) {
            item.quantity += change;
            if (item.quantity <= 0) {
                removeFromCart(itemId);
            } else {
                updateCartDisplay();
            }
        }
    }

    function updateCartDisplay() {
        if (cart.length === 0) {
            cartSection.classList.add('hidden');
            totalAmount.textContent = '0 ‡∏ö‡∏≤‡∏ó';
            calculateChange();
            return;
        }

        cartSection.classList.remove('hidden');
        cartItems.innerHTML = cart.map(item => `
            <div class="flex items-center justify-between bg-gray-900 p-3 rounded-lg border border-gray-700">
                <div class="flex-1">
                    <div class="font-medium text-gray-100">
                        ${item.emoji} ${item.product}
                        ${item.type ? `<span class="text-xs bg-blue-900 text-blue-300 px-2 py-1 rounded-full ml-2">${item.type}</span>` : ''}
                    </div>
                    <div class="text-sm text-gray-400">${item.price} ‡∏ö‡∏≤‡∏ó/‡∏ä‡∏¥‡πâ‡∏ô</div>
                </div>
                <div class="flex items-center space-x-2">
                    <button type="button" data-action="decrease" data-item-id="${item.id}" class="w-8 h-8 bg-gray-700 rounded-full flex items-center justify-center text-gray-200 hover:bg-gray-600">-</button>
                    <span class="w-8 text-center font-medium text-gray-200">${item.quantity}</span>
                    <button type="button" data-action="increase" data-item-id="${item.id}" class="w-8 h-8 bg-gray-700 rounded-full flex items-center justify-center text-gray-200 hover:bg-gray-600">+</button>
                    <button type="button" data-action="remove" data-item-id="${item.id}" class="w-8 h-8 bg-red-900 bg-opacity-40 rounded-full flex items-center justify-center text-red-400 hover:bg-red-800 ml-2">√ó</button>
                </div>
            </div>
        `).join('');

        const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        totalAmount.textContent = `${total} ‡∏ö‡∏≤‡∏ó`;
        calculateChange();
    }
    
    function calculateChange() {
        const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const received = parseFloat(receivedAmountInput.value) || 0;
        
        if (received === 0 && receivedAmountInput.value === '') {
            changeDisplay.classList.add('hidden');
            insufficientWarning.classList.add('hidden');
            return;
        }
        
        if (received < total) {
            changeDisplay.classList.add('hidden');
            insufficientWarning.classList.remove('hidden');
        } else {
            insufficientWarning.classList.add('hidden');
            const change = received - total;
            changeAmount.textContent = `${change} ‡∏ö‡∏≤‡∏ó`;
            changeDisplay.classList.remove('hidden');
        }
    }

    async function handleFormSubmit(e) {
        e.preventDefault();
        
        if (cart.length === 0) {
            errorSound.play();
            alert('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢');
            return;
        }
        
        const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
        const received = parseFloat(receivedAmountInput.value) || 0;
        
        if (received < total) {
            errorSound.play();
            alert('‚ö†Ô∏è ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏±‡∏ö‡πÑ‡∏°‡πà‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠');
            return;
        }
        
        const change = received - total;
        
        const saleRecord = {
            id: Date.now(),
            items: [...cart],
            total: total,
            received: received,
            change: change,
            timestamp: new Date().toISOString(),
            date: new Date().toDateString()
        };

        salesData.push(saleRecord);
        localStorage.setItem('salesData', JSON.stringify(salesData));
        saveToGoogleSheets(saleRecord);
        
        saleSuccessSound.play();

        showPrintChoiceModal(saleRecord);

        cart = [];
        receivedAmountInput.value = '';
        updateCartDisplay();
    }

    function showQuantityModal(product) {
        const modal = document.createElement('div');
        modal.id = 'quantityModal';
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.innerHTML = `
            <div class="bg-gray-800 rounded-xl p-6 m-4 max-w-sm w-full fade-in">
                <h3 class="text-lg font-semibold mb-4 text-white">${product.emoji} ${product.name}</h3>
                
                <div id="quantityDisplay" class="text-right text-4xl font-bold text-white bg-gray-700 p-3 rounded-lg mb-4" style="min-height: 64px;">1</div>
                
                <div class="grid grid-cols-3 gap-2 mb-4">
                    <button class="numpad-btn w-full py-3 bg-gray-700 text-white rounded-lg text-xl font-medium hover:bg-gray-600" data-value="1">1</button>
                    <button class="numpad-btn w-full py-3 bg-gray-700 text-white rounded-lg text-xl font-medium hover:bg-gray-600" data-value="2">2</button>
                    <button class="numpad-btn w-full py-3 bg-gray-700 text-white rounded-lg text-xl font-medium hover:bg-gray-600" data-value="3">3</button>
                    <button class="numpad-btn w-full py-3 bg-gray-700 text-white rounded-lg text-xl font-medium hover:bg-gray-600" data-value="4">4</button>
                    <button class="numpad-btn w-full py-3 bg-gray-700 text-white rounded-lg text-xl font-medium hover:bg-gray-600" data-value="5">5</button>
                    <button class="numpad-btn w-full py-3 bg-gray-700 text-white rounded-lg text-xl font-medium hover:bg-gray-600" data-value="6">6</button>
                    <button class="numpad-btn w-full py-3 bg-gray-700 text-white rounded-lg text-xl font-medium hover:bg-gray-600" data-value="7">7</button>
                    <button class="numpad-btn w-full py-3 bg-gray-700 text-white rounded-lg text-xl font-medium hover:bg-gray-600" data-value="8">8</button>
                    <button class="numpad-btn w-full py-3 bg-gray-700 text-white rounded-lg text-xl font-medium hover:bg-gray-600" data-value="9">9</button>
                    <button id="numpadDel" class="w-full py-3 bg-red-800 text-white rounded-lg text-xl font-medium hover:bg-red-700">‡∏•‡∏ö</button>
                    <button class="numpad-btn w-full py-3 bg-gray-700 text-white rounded-lg text-xl font-medium hover:bg-gray-600" data-value="0">0</button>
                    <button id="numpadClear" class="w-full py-3 bg-yellow-600 text-white rounded-lg text-xl font-medium hover:bg-yellow-500">C</button>
                </div>
                
                <div class="flex gap-3">
                    <button id="cancelQtyModal" class="w-full py-3 px-4 border border-gray-500 rounded-lg hover:bg-gray-600 transition-colors text-white">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                    <button id="confirmQtyModal" class="w-full py-3 px-4 bg-blue-500 hover:bg-blue-600 rounded-lg transition-colors text-white font-medium">‡∏ï‡∏Å‡∏•‡∏á</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);

        const display = modal.querySelector('#quantityDisplay');
        let currentQuantityStr = '1';
        let isDefaultValue = true; 

        const updateDisplay = () => {
            display.textContent = currentQuantityStr || '0';
        };

        modal.querySelectorAll('.numpad-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const value = btn.dataset.value;

                if (isDefaultValue) {
                    currentQuantityStr = value; 
                    isDefaultValue = false;
                } else if (currentQuantityStr === '0' && value !== '0') {
                    currentQuantityStr = value; 
                } else if (currentQuantityStr.length < 5) { 
                    currentQuantityStr += value; 
                }
                updateDisplay();
            });
        });

        modal.querySelector('#numpadDel').addEventListener('click', () => {
            currentQuantityStr = currentQuantityStr.slice(0, -1);
            if (currentQuantityStr === '') {
                currentQuantityStr = '1'; 
                isDefaultValue = true; 
            } else {
                isDefaultValue = false;
            }
            updateDisplay();
        });

        modal.querySelector('#numpadClear').addEventListener('click', () => {
            currentQuantityStr = '1';
            isDefaultValue = true; 
            updateDisplay();
        });

        const closeModal = () => document.body.removeChild(modal);

        modal.querySelector('#cancelQtyModal').addEventListener('click', closeModal);
        modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });

        modal.querySelector('#confirmQtyModal').addEventListener('click', () => {
            const quantity = parseInt(currentQuantityStr, 10);
            if (quantity > 0) {
                if (product.requiresType) {
                    showTypeSelectionModal(product, quantity); 
                } else {
                    addToCart(product, '', quantity); 
                }
                closeModal();
            }
        });
    }

    function showTypeSelectionModal(product, quantity) {
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.innerHTML = `
            <div class="bg-gray-800 rounded-xl p-6 m-4 max-w-sm w-full fade-in">
                <h3 class="text-lg font-semibold mb-4 text-white">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó ${product.emoji} ${product.name} (x${quantity})</h3>
                <div class="space-y-3 mb-6">
                    <button class="type-btn w-full p-3 border border-gray-600 rounded-lg hover:bg-gray-700 transition-colors text-left text-white" data-type="‡πÅ‡∏¢‡∏Å‡∏ô‡πâ‡∏≥">ü•ó ‡πÅ‡∏¢‡∏Å‡∏ô‡πâ‡∏≥</button>
                    <button class="type-btn w-full p-3 border border-gray-600 rounded-lg hover:bg-gray-700 transition-colors text-left text-white" data-type="‡∏ä‡∏∏‡∏î‡πÇ‡∏£‡∏á‡∏ó‡∏≤‡∏ô">‡∏ä‡∏∏‡∏î‡πÇ‡∏£‡∏á‡∏ó‡∏≤‡∏ô</button>
                </div>
                <button id="cancelModal" class="w-full py-2 px-4 border border-gray-500 rounded-lg hover:bg-gray-600 transition-colors text-white">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            </div>
        `;
        document.body.appendChild(modal);
        
        const closeModal = () => document.body.removeChild(modal);
        
        modal.querySelectorAll('.type-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                addToCart(product, btn.dataset.type, quantity); 
                closeModal();
            });
        });
        
        modal.querySelector('#cancelModal').addEventListener('click', closeModal);
        modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
    }
    
    function showPrintChoiceModal(saleRecord) {
        const modalId = 'print-choice-modal';
        const existingModal = document.getElementById(modalId);
        if (existingModal) existingModal.remove();

        const modal = document.createElement('div');
        modal.id = modalId;
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.innerHTML = `
            <div class="bg-gray-800 rounded-xl p-6 m-4 max-w-sm w-full fade-in text-center">
                <div class="text-5xl mb-3">‚úÖ</div>
                <h3 class="text-lg font-semibold text-gray-100">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!</h3>
                <p class="text-gray-300 mb-6">‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏≠‡∏ô: <span class="text-2xl font-bold text-green-400">${saleRecord.change}</span> ‡∏ö‡∏≤‡∏ó</p>
                <div class="flex flex-col gap-3">
                    <button id="print-receipt-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-medium py-3 px-4 rounded-lg transition-colors">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</button>
                    <button id="close-modal-btn" class="w-full bg-gray-600 hover:bg-gray-500 text-gray-100 font-medium py-2 px-4 rounded-lg transition-colors">‡∏õ‡∏¥‡∏î</button>
                </div>
            </div>
        `;
        document.body.appendChild(modal);

        const closeModal = () => {
            const modalElement = document.getElementById(modalId);
            if (modalElement) modalElement.remove();
        };

        document.getElementById('print-receipt-btn').addEventListener('click', () => {
            printReceipt(saleRecord);
            closeModal();
        });
        document.getElementById('close-modal-btn').addEventListener('click', closeModal);
        modal.addEventListener('click', (e) => { if (e.target === modal) closeModal(); });
    }

    function checkGoogleScriptUrl() {
        if (!GOOGLE_SCRIPT_URL || GOOGLE_SCRIPT_URL.includes('YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE')) {
            googleSheetStatus.textContent = '(‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Google Apps Script)';
            googleSheetStatus.className = 'text-xs text-red-500 text-center mt-1';
        } else {
            googleSheetStatus.textContent = '(‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Sheets ‡πÅ‡∏•‡πâ‡∏ß)';
            googleSheetStatus.className = 'text-xs text-green-400 text-center mt-1';
        }
    }

    async function saveToGoogleSheets(saleRecord) {
        if (!GOOGLE_SCRIPT_URL || GOOGLE_SCRIPT_URL.includes('YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE')) return;
        try {
            googleSheetStatus.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
            await fetch(GOOGLE_SCRIPT_URL, {
                method: 'POST', mode: 'no-cors', cache: 'no-cache',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(saleRecord)
            });
            checkGoogleScriptUrl();
        } catch (error) {
            console.error('Error saving to Google Sheets:', error);
            googleSheetStatus.textContent = '(‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à)';
            googleSheetStatus.className = 'text-xs text-red-500 text-center mt-1';
        }
    }
    
    const Tis620Encoder = {
        encode: function(str) {
            const buffer = [];
            for (let i = 0; i < str.length; i++) {
                const code = str.charCodeAt(i);
                if (code >= 0x0E01 && code <= 0x0E5B) buffer.push(code - 0x0D40);
                else buffer.push(code);
            }
            return new Uint8Array(buffer);
        }
    };
    
    async function connectBluetoothPrinter() {
        const PRINTER_SERVICE_UUID = '49535343-fe7d-4ae5-8fa9-9fafd205e455';
        const PRINTER_CHARACTERISTIC_UUID = '49535343-8841-43f4-a8d4-ecbe34729bb3';

        try {
            const device = await navigator.bluetooth.requestDevice({
                 acceptAllDevices: true,
                 optionalServices: [PRINTER_SERVICE_UUID]
            });
            const server = await device.gatt.connect();
            const service = await server.getPrimaryService(PRINTER_SERVICE_UUID);
            const characteristic = await service.getCharacteristic(PRINTER_CHARACTERISTIC_UUID);
            
            bluetoothCharacteristic = characteristic;
            const printerStatus = document.getElementById('printerStatus');
            printerStatus.textContent = '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß';
            printerStatus.className = 'text-xs px-2 py-1 rounded-full bg-green-900 text-green-300';
            
            device.addEventListener('gattserverdisconnected', () => {
                bluetoothCharacteristic = null;
                printerStatus.textContent = '‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠';
                printerStatus.className = 'text-xs px-2 py-1 rounded-full bg-gray-700 text-gray-300';
            });

        } catch (error) {
            console.error('Error connecting to Bluetooth printer:', error);
            alert('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡πÑ‡∏î‡πâ: ' + error.message + '\n\n‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡∏∞‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏¢‡∏∞');
        }
    }

    async function printReceiptBluetooth(saleRecord) {
        if (!bluetoothCharacteristic) {
            alert("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå Bluetooth");
            return;
        }
        try {
            const encoder = Tis620Encoder;
            const receiptWidth = 32;

            const formatLine = (left, right = '') => {
                const leftStr = String(left);
                const rightStr = String(right);
                const paddingCount = Math.max(0, receiptWidth - leftStr.length - rightStr.length);
                const padding = ' '.repeat(paddingCount);
                return `${leftStr}${padding}${rightStr}\n`;
            };
            
            const commands = {
                init: new Uint8Array([0x1B, 0x40]),
                alignCenter: new Uint8Array([0x1B, 0x61, 0x01]),
                alignLeft: new Uint8Array([0x1B, 0x61, 0x00]),
                boldOn: new Uint8Array([0x1B, 0x45, 0x01]),
                boldOff: new Uint8Array([0x1B, 0x45, 0x00]),
                fontA: new Uint8Array([0x1B, 0x21, 0x00]),
                fontB: new Uint8Array([0x1B, 0x21, 0x01]),
                feedAndCut: new Uint8Array([0x0A, 0x0A, 0x0A, 0x1D, 0x56, 0x42, 0x00]),
            };
            
            const send = async (data) => await bluetoothCharacteristic.writeValue(data);
            const sendText = async (text) => await send(encoder.encode(text));
            const line = '-'.repeat(receiptWidth) + '\n';

            await send(commands.init);

            await send(commands.alignCenter);
            await send(commands.boldOn);
            await sendText('‡∏¢‡∏≥‡∏´‡∏°‡∏µ‡πà‡πÑ‡∏Å‡πà‡∏â‡∏µ‡∏Å ‡∏ä‡∏¥‡∏Å‡∏ä‡∏¥‡∏Å‡πÄ‡∏Å‡πâ‡∏ô‡∏â‡∏µ‡∏Å\n');
            await send(commands.boldOff);
            await sendText('‡∏™‡∏≤‡∏Ç‡∏≤ ‡πÇ‡∏•‡∏ï‡∏±‡∏™‡∏ï‡∏•‡∏≤‡∏î‡πÇ‡∏ã‡∏ô‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á\n');
            await sendText('(‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏¢‡πà‡∏≠)\n');
            await sendText(line);
            
            await send(commands.alignLeft);
            const saleDate = new Date(saleRecord.timestamp);
            await sendText(formatLine(`‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à: ${saleRecord.id}`));
            await sendText(formatLine(`‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${saleDate.toLocaleString('th-TH')}\n`));
            await sendText(line);

            await send(commands.fontA);
            await send(commands.boldOn);
            await sendText('‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤\n');
            await send(commands.boldOff);

            for (const item of saleRecord.items) {
                const itemName = `${item.quantity} ${item.product}${item.type ? `(${item.type})` : ''}`;
                const itemPrice = `${item.price.toFixed(2)} ‡∏ø`; 
                await sendText(formatLine(itemName, itemPrice));
            }
            await sendText(line);

            await send(commands.fontA);
            await sendText(formatLine('‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°:', `${saleRecord.total.toFixed(2)}`));
            await sendText(formatLine('‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô:', `${saleRecord.received.toFixed(2)}`));
            await send(commands.boldOn);
            await sendText(formatLine('‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏≠‡∏ô:', `${saleRecord.change.toFixed(2)}`));
            await send(commands.boldOff);
            
            await sendText(line);
            await sendText(line);
            
            await send(commands.alignCenter);
            await sendText('‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠\n');
            await sendText('‡πÇ‡∏ó‡∏£: 093-145-0736\n');
            await sendText('Facebook: ‡∏ä‡∏¥‡∏Å‡∏ä‡∏¥‡∏Å‡πÄ‡∏Å‡πâ‡∏ô‡∏â‡∏µ‡∏Å\n');

            await sendText('‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏ó‡∏≤‡∏á‡πÑ‡∏•‡∏ô‡πå\n');
            await sendText(line);

            await send(commands.boldOn);
            await sendText('‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£\n');
            await send(commands.boldOff);
            await sendText(line);

            await send(commands.feedAndCut);

        } catch (error) {
            console.error('Error printing receipt:', error);
            alert('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à: ' + error.message);
        }
    }
    
    function printReceiptPC(saleRecord) {
        const receiptContainer = document.getElementById('receipt-for-pc');
        const saleDate = new Date(saleRecord.timestamp);
        
        const itemsHtml = saleRecord.items.map(item => `
            <tr>
                <td colspan="2" style="padding: 2px 0;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <span style="text-align: left; padding-right: 10px;">${item.quantity} ${item.product} ${item.type ? `(${item.type})` : ''}</span>
                        <span style="text-align: right; white-space: nowrap;">${item.price.toFixed(2)} ‡∏ø</span>
                    </div>
                </td>
            </tr>
        `).join('');

        receiptContainer.innerHTML = `
            <div style="text-align: center;">
                <h3 style="font-size: 12pt; font-weight: bold; margin: 0;">‡∏¢‡∏≥‡∏´‡∏°‡∏µ‡πà‡πÑ‡∏Å‡πà‡∏â‡∏µ‡∏Å ‡∏ä‡∏¥‡∏Å‡∏ä‡∏¥‡∏Å‡πÄ‡∏Å‡πâ‡∏ô‡∏â‡∏µ‡∏Å</h3>
                <p style="margin: 0 0 2px 0;">‡∏™‡∏≤‡∏Ç‡∏≤ ‡πÇ‡∏•‡∏ï‡∏±‡∏™‡∏ï‡∏•‡∏≤‡∏î‡πÇ‡∏ã‡∏ô‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á</p>
                <p style="margin: 0 0 5px 0;">(‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏¢‡πà‡∏≠)</p>
            </div>
            <hr style="border: none; border-top: 1px dashed #000; margin: 5px 0;">
            <p style="margin: 0;">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à: ${saleRecord.id}</p>
            <p style="margin: 0;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${saleDate.toLocaleString('th-TH')}</p>
            <hr style="border: none; border-top: 1px dashed #000; margin: 5px 0;">
            <h3 style="font-size: 10pt; font-weight: bold; margin: 0;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h3>
            <table style="width: 100%; border-collapse: collapse;">${itemsHtml}
            </table>
            <hr style="border: none; border-top: 1px dashed #000; margin: 5px 0;">
            <table style="width: 100%;">
                <tr style="font-size: 11pt; font-weight: bold;"><td>‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°:</td><td style="text-align: right;">${saleRecord.total.toFixed(2)}</td></tr>
                <tr><td>‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô:</td><td style="text-align: right;">${saleRecord.received.toFixed(2)}</td></tr>
                <tr font-weight: bold;"><td>‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏≠‡∏ô:</td><td style="text-align: right;">${saleRecord.change.toFixed(2)}</td></tr>
            </table>
            <hr style="border: none; border-top: 1px dashed #000; margin: 5px 0;">
            <hr style="border: none; border-top: 1px dashed #000; margin: 5px 0;">
            <p style="font-size: 11pt; text-align: center; margin: 0;">‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</p>
            <p style="font-size: 11pt; text-align: center; margin: 0;">‡πÇ‡∏ó‡∏£: 093-145-0736</p>
            <p style="font-size: 11pt; text-align: center; margin: 0;">Facebook: ‡∏ä‡∏¥‡∏Å‡∏ä‡∏¥‡∏Å‡πÄ‡∏Å‡πâ‡∏ô‡∏â‡∏µ‡∏Å</p>
            <div style="text-align: center; font-size: 8pt; color: #555;">
                <img src="https://qr-official.line.me/gs/M_830jgqvb_BW.png?oat_content=qr" alt="QR Code" style="display: block; margin: 0px auto; width: 80px; height: 80px;">
                <p style="margin: 8px 0 0 0;">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏≠‡∏ô‡∏ó‡∏≤‡∏á‡πÑ‡∏•‡∏ô‡πå</p>
            </div>
            <br style="border: none; border-top: 1px dashed #000; margin: 5px 0;">
            <p style="font-size: 12pt; text-align: center; margin: 0;">‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£</p>
            <br style="border: none; border-top: 1px dashed #000; margin: 5px 0;">
        `;
        window.print();
    }

    function printReceipt(saleRecord) {
        if (!saleRecord) return;
        if (bluetoothCharacteristic) printReceiptBluetooth(saleRecord);
        else printReceiptPC(saleRecord);
    }
    
    function displayHistory() {
        const todayTotalEl = document.getElementById('todayTotal');
        const noHistoryEl = document.getElementById('noHistory');
        const searchQuery = searchInput.value.toLowerCase();
        
        const reversedSales = [...salesData].reverse();

        const filteredSales = reversedSales.filter(sale => {
            if (!searchQuery) return true;
            const saleIdMatch = sale.id.toString().includes(searchQuery);
            const itemMatch = sale.items.some(item => 
                item.product.toLowerCase().includes(searchQuery)
            );
            return saleIdMatch || itemMatch;
        });

        if (filteredSales.length === 0) {
            salesHistoryContainer.innerHTML = '';
            noHistoryEl.classList.remove('hidden');
            if (searchQuery) {
                noHistoryEl.querySelector('p').textContent = `‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö "${searchQuery}"`;
            } else {
                noHistoryEl.querySelector('p').textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢';
            }
        } else {
            noHistoryEl.classList.add('hidden');
        }

        const today = new Date().toDateString();
        const todaySalesTotal = salesData
            .filter(sale => sale.date === today)
            .reduce((sum, sale) => sum + sale.total, 0);
        todayTotalEl.textContent = `${todaySalesTotal.toLocaleString()} ‡∏ö‡∏≤‡∏ó`;

        salesHistoryContainer.innerHTML = filteredSales.map(sale => {
            const saleDate = new Date(sale.timestamp);
            const formattedDateTime = saleDate.toLocaleString('th-TH', {
                year: 'numeric', month: '2-digit', day: '2-digit',
                hour: '2-digit', minute: '2-digit'
            });

            return `
            <div class="bg-gray-800 p-4 rounded-lg border border-gray-700">
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <div class="font-semibold text-gray-200">${formattedDateTime}</div>
                        <div class="text-xs text-gray-400">ID: ${sale.id}</div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold text-lg text-blue-400">${sale.total} ‡∏ö‡∏≤‡∏ó</div>
                        <div class="text-xs text-gray-400">‡∏£‡∏±‡∏ö: ${sale.received} | ‡∏ó‡∏≠‡∏ô: ${sale.change}</div>
                    </div>
                </div>
                <ul class="text-sm text-gray-300 space-y-1 border-t border-gray-700 pt-2 mt-2">
                    ${sale.items.map(item => `
                        <li class="flex justify-between">
                            <span>${item.emoji} ${item.quantity}x ${item.product} ${item.type ? `(${item.type})` : ''}</span>
                            <span>${(item.price * item.quantity).toFixed(2)}</span>
                        </li>
                    `).join('')}
                </ul>
                <div class="border-t border-gray-700 mt-3 pt-3 text-right flex justify-end gap-2">
                    <button data-sale-id="${sale.id}" class="reprint-btn bg-gray-700 hover:bg-gray-600 text-gray-200 text-sm font-medium py-1 px-3 rounded-lg transition-colors">
                        üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á
                    </button>
                    <button data-sale-id="${sale.id}" class="delete-btn bg-red-900/50 hover:bg-red-900/70 text-red-400 text-sm font-medium py-1 px-3 rounded-lg transition-colors">
                        üóëÔ∏è ‡∏•‡∏ö
                    </button>
                </div>
            </div>`;
        }).join('');
    }
    
    function reprintReceipt(saleId) {
        const saleToReprint = salesData.find(s => s.id === saleId);
        if (saleToReprint) printReceipt(saleToReprint);
        else alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏°‡∏û‡πå');
    }

    function deleteSaleRecord(saleId) {
        const password = prompt("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö:");
        if (password === null) return;
        if (password === 'Pass123') {
            if (confirm('‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ñ‡∏≤‡∏ß‡∏£?')) {
                salesData = salesData.filter(s => s.id !== saleId);
                localStorage.setItem('salesData', JSON.stringify(salesData));
                deleteSound.play();
                displayHistory();
            }
        } else {
            errorSound.play();
            alert('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!');
        }
    }

</script>
</body>
</html>


